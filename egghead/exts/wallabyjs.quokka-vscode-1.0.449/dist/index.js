/*
 * quokka-vscode - v1.0.449
 * Copyright (c) 2017-2022 WallabyJs - All Rights Reserved.
 */

!function e(t,i,s){process.env.WALLABY_PRODUCTION=!0;var a="function"==typeof require&&require;module.exports=function o(n,r){if(!i[n]){if(!t[n]){var l="function"==typeof require&&require;if(!r&&l)return l(n,!0);if(a)return a(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var h=i[n]={exports:{}};t[n][0].call(h.exports,function(e){var i=t[n][1][e];return o(i||e)},h,h.exports,e,t,i,s)}return i[n].exports}(s[0])}({1:[function(e,t,i){"use strict";let s=e("os"),a=e("fs"),o=e("path"),n=e("vscode"),r=e("./lib/compositeDisposable"),l=n.window;const c=e("./lib/startViewPanel");class h{async activate(t){n.window.registerWebviewPanelSerializer&&n.window.registerWebviewPanelSerializer(c.viewType,{async deserializeWebviewPanel(e,i){c.revive(e,t)}});let i=this;i._disposables=new r,i._setupStatusIndicator();let s=e(t.globalState.get("corePath")),a={context:t,coreClient:s,statusBar:i._statusBar,deactivate:()=>i.deactivate(),version:h._getVersion()},o=e("./lib/controller");i._controller=new o(a),i._controller.activate(),i._disposables.add(()=>i._controller.deactivate())}static _getVersion(){let e=1,t=0;try{let i=n.version.split(".");e=parseInt(i[0],10),t=parseInt(i[1],10)}catch(e){}return{major:e,minor:t}}_setupStatusIndicator(){this._startPageIndicator=l.createStatusBarItem(n.StatusBarAlignment.Left,-1e13),this._startPageIndicator.text="Quokka",this._startPageIndicator.tooltip="Quokka (click to open start view)",this._startPageIndicator.command="quokka.openStartView",this._startPageIndicator.show(),n.workspace.getConfiguration().get("quokka.startViewStatusBar",!0)||this._startPageIndicator.hide(),n.workspace.onDidChangeConfiguration(e=>{n.workspace.getConfiguration().get("quokka.startViewStatusBar",!0)?this._startPageIndicator.show():this._startPageIndicator.hide()});let e=this;e._statusBar=l.createStatusBarItem(n.StatusBarAlignment.Right,-1e13),e._statusBar.show();let t=e._statusBar.hide.bind(e._statusBar),i=e._statusBar.dispose.bind(e._statusBar);e._statusBar.hide=(()=>{e._statusBar.stopProgress(),e._statusBar._mainText="",e._statusBar._extensionText="",e._statusBar.updateText(),t()}),e._statusBar.dispose=(()=>{e._statusBar.stopProgress(),i()}),e._statusBar.displayProgress=(()=>{let t=0,i=["[=-----]","[-=----]","[--=---]","[---=--]","[----=-]","[-----=]","[----=-]","[---=--]","[--=---]","[-=----]"];clearInterval(e._statusBar._progress),e._statusBar._progress=setInterval(()=>{e._statusBar.setMainText(`${i[t=++t%i.length]}   `),e._statusBar._doUpdateText()},150)}),e._statusBar.setMainText=(t=>{e._statusBar._mainText=t}),e._statusBar.setExtensionText=(t=>{e._statusBar._extensionText=t}),e._statusBar.updateText=(()=>e._statusBar._doUpdateText()),e._statusBar._doUpdateText=(()=>{e._statusBar.text=`${e._statusBar._mainText||""} ${e._statusBar._extensionText||""}`}),e._statusBar.stopProgress=(()=>{clearInterval(e._statusBar._progress),delete e._statusBar._progress}),e._statusUpdater=(t=>{e._statusBar.tooltip=t}),e._disposables.add(()=>{e._removeStatusIndicator()}),e._statusBar.hide()}_hideStatusIndicator(){this._statusBar&&(this._statusBar.text="",this._statusBar.tooltip="",this._statusBar.hide()),this._statusUpdater=(()=>{})}_removeStatusIndicator(){this._statusBar&&this._statusBar.dispose(),this._statusUpdater=(()=>{})}deactivate(){this._disposables.dispose()}}i.activate=(e=>{let t=new h;e.subscriptions.push({dispose:()=>t.deactivate()});const i=h._getVersion();if(i.major<=1&&i.minor<18){const e=process.exit,i=function(){t.deactivate(),e.apply(process,arguments)},s=process.exit=function(){i.apply(null,arguments)};process.on("SIGINT",function(){s.apply(null,arguments)}),process.on("SIGTERM",function(){s.apply(null,arguments)}),process.on("exit",function(){s.apply(null,arguments)})}try{let t=n.workspace.getConfiguration();if(t){let i=t.get("quokka.colors",{});i&&Object.keys(i).forEach(t=>{try{if(!t)return;let n=e.asAbsolutePath(o.join("images",t+".svg"));if(!a.existsSync(n))return;const r=('<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="100%" height="100%">'+s.EOL+"  <g>"+s.EOL+'    <rect x="22%" y="22%" width="56%" height="56%" rx="12%" ry="12%" style="fill:#62b455;fill-opacity:1;" />'+s.EOL+"  </g>"+s.EOL+"</svg>").replace(/fill:#.[^;]*/,"fill:"+i[t]),l=a.readFileSync(n).toString();r.replace(/\r/g,"")!==l.replace(/\r/g,"")&&a.writeFileSync(n,r)}catch(e){console.error("Failed to set icon "+t+" type to "+i[t]+". "+e.message)}})}}catch(e){}t.activate(e)})},{"./lib/compositeDisposable":6,"./lib/controller":7,"./lib/startViewPanel":11,fs:void 0,os:void 0,path:void 0,vscode:void 0}],2:[function(e,t,i){"use strict";var s=e("vscode"),a=e("path");i.activate=function(t){var i=s.workspace.getConfiguration()&&s.workspace.getConfiguration().get("quokka.debug",!1);i?(global.originalRequire=e,t.globalState.update("corePath","../../wallaby/client")):t.globalState.update("corePath","./wallaby/client"),i?e("./out/extension").activate(t):"dist"===a.basename(__dirname)?e("./extension").activate(t):(global.originalRequire=e,e("./dist/index").activate(t))}},{"./extension":1,path:void 0,vscode:void 0}],3:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.InteractiveExamples=void 0;const s=e("path"),a=e("fs"),o=e("os"),n=e("https");i.InteractiveExamples=class{constructor(){this.examples=[],this.disposable=void 0,this.disposed=!1,this.configPath=s.join(o.homedir(),".quokka","examples.json"),this.examplesPath=s.join(o.homedir(),".quokka","interactive-examples")}async httpGet(e){return new Promise((t,i)=>{n.get(e,{headers:{"User-Agent":"Quokka-VSCode-Extension"}},async e=>{if(e.statusCode&&e.statusCode>=300&&e.statusCode<400&&e.headers.location)try{const s=await this.httpGet(e.headers.location);t(s)}catch(e){i(e)}else{let i=Buffer.alloc(0);e.on("data",e=>{i=Buffer.concat([i,e])}),e.on("end",()=>{t(i)})}}).on("error",e=>{i(e)})})}deleteOldExamplesFolder(){const e=function(t){a.existsSync(t)&&(a.readdirSync(t).forEach(function(i){var o=s.join(t,i);a.lstatSync(o).isDirectory()?e(o):a.unlinkSync(o)}),a.rmdirSync(t))};e(this.examplesPath)}getExampleMetaInformation(){let e=[];const t=this.examplesPath,i=function(o){a.existsSync(o)&&a.readdirSync(o).forEach(function(n){var r=s.join(o,n);if(a.lstatSync(r).isDirectory())i(r);else if("meta.json"===n)try{const i=JSON.parse(a.readFileSync(r).toString());e=[...e,...i.map(e=>(e.folder=s.relative(t,o),e.label=e.title,delete e.title,e))]}catch(e){}})};return i(this.examplesPath),e}async initialize(){try{if(a.existsSync(this.configPath)){const e=JSON.parse(a.readFileSync(this.configPath).toString());this.examples=e.examples,this.nextCheckTime=e.nextCheckTime,this.sha=e.sha,this.date=e.date}}catch(e){console.error(e)}if(!this.nextCheckTime||(new Date).getTime()>this.nextCheckTime){const t="https://api.github.com/repos/wallabyjs/interactive-examples/commits"+(this.date?"?since"+this.date:"");try{const i=await this.httpGet(t),n=JSON.parse(i.toString());if(n.length&&this.sha!==n[0].sha){const t=await this.httpGet("https://github.com/wallabyjs/interactive-examples/archive/master.zip");new(e("adm-zip"))(t).extractAllTo(s.join(o.homedir(),".quokka"),!0),this.deleteOldExamplesFolder(),a.renameSync(s.join(o.homedir(),".quokka","interactive-examples-master"),this.examplesPath),this.examples=this.getExampleMetaInformation(),this.sha=n[0].sha,this.date=n[0].commit.committer.date,this.nextCheckTime=(new Date).getTime()+864e5,a.writeFileSync(this.configPath,JSON.stringify({examples:this.examples,nextCheckTime:this.nextCheckTime,sha:this.sha,date:this.date}))}}catch(e){console.error(e)}}}getExamples(){return this.examples||[]}getContent(e){try{return a.readFileSync(s.join(this.examplesPath,e.folder,e.fileName)).toString()}catch(e){return""}}getLanguage(e){return"ts"===e.type?"TypeScript":"JavaScript"}getRelativeFilePath(e){return s.join(e.folder,e.fileName)}dispose(){this.disposable&&this.disposable.dispose(),this.disposed=!0}}},{"adm-zip":void 0,fs:void 0,https:void 0,os:void 0,path:void 0}],4:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SalesEvent=void 0;const s=e("path"),a=e("fs"),o=e("os"),n=e("vscode"),r=e("./licenseReader"),l=s.join(o.homedir(),".quokka","state.json"),c=[{discount:50,saleName:"Black Friday",start:new Date(Date.UTC(2021,10,22,0,0,0,0)).getTime(),end:new Date(Date.UTC(2021,10,29,0,0,0,0)).getTime()},{discount:40,saleName:"Cyber Week",start:new Date(Date.UTC(2021,10,29,0,0,0,0)).getTime(),end:new Date(Date.UTC(2021,11,6,0,0,0,0)).getTime()},{discount:30,saleName:"Holiday",start:new Date(Date.UTC(2021,11,6,0,0,0,0)).getTime(),end:new Date(Date.UTC(2021,11,13,0,0,0,0)).getTime()},{discount:25,saleName:"Holiday",start:new Date(Date.UTC(2021,11,13,0,0,0,0)).getTime(),end:new Date(Date.UTC(2021,11,20,0,0,0,0)).getTime()}];class h{constructor(e,t){this.disposable=void 0,this.disposed=!1,this.gift=void 0;const i=c.reduce((e,t)=>((void 0===e.start||e.start>t.start)&&(e.start=t.start),(void 0===e.end||e.end<t.end)&&(e.end=t.end),e),{start:void 0,end:void 0});this.start=new Date(i.start),this.end=new Date(i.end),this.nextCheckTime=void 0,this.buildDate=e||new Date,this.gift=t,this.setup()}setup(){const e=r.LicenseReader.getLicenseDetails(this.buildDate);e&&!e.newInstall&&"activated"!==e.state&&new Date<=this.end&&(this.nextCheckTime=this.getNextCheckTime()||this.start,this.nextCheckTime<this.end&&(this.checkAndShowMessage(),this.disposable=n.window.onDidChangeActiveTextEditor(()=>{this.checkAndShowMessage()})))}saleInProgress(){const e=new Date;return e>this.start&&e<this.end}checkAndShowMessage(){const e=r.LicenseReader.getLicenseDetails(this.buildDate);if(!e||"activated"!==e.state&&"activating"!==e.state){const t=new Date;!this.disposed&&t>this.start&&t<this.end&&this.nextCheckTime&&t>=this.nextCheckTime&&(this.nextCheckTime=this.setNextCheckTime(),this.showMessageAndHandleUserResponse(e))}else this.setNextCheckTimeToEndDate(),this.dispose()}discountAmount(){const e=(new Date).getTime(),t=c.find(t=>e>=t.start&&e<t.end);return t?t.discount:0}showMessageAndHandleUserResponse(e){const t="expiring"===e.state,i=(new Date).getTime(),s=c.find(e=>i>=e.start&&i<e.end);if(!s)return;if(t&&s.discount<=30)return;const a=(t?"Renew":"Get")+` Quokka.js Pro 🚀 today with our limited time ${s.discount}% ${s.saleName} discount!`;try{const e=h.readStateFile();e.lastUrlOpen&&!e.th?(h.updateStateFile({th:(new Date).getTime()}),n.window.showInformationMessage("We saw you recently looked at Quokka 'PRO' and prepared a short 🎁 treasure hunt 🎁 for you!",{title:"Start Adventure",gift:!0},{title:"Don't show again",dontShow:!0}).then(e=>this.handleUserResponse(e))):n.window.showInformationMessage(a,{title:"Buy License",url:n.Uri.parse("https://wallabyjs.com/store/personal/?referrer=qsp#select-quokka")},{title:"Read More",url:n.Uri.parse("https://quokkajs.com/pro/?referrer=qsp")},{title:"Don't show again",dontShow:!0}).then(e=>this.handleUserResponse(e))}catch(e){}}handleUserResponse(e){e&&(e.dontShow?(this.setNextCheckTimeToEndDate(),this.dispose()):e.url?(this.setLastUrlOpenedTime(),n.commands.executeCommand("vscode.open",e.url)):e.gift&&(this.setNextCheckTimeToEndDate(),this.dispose(),this.gift&&this.gift()))}static updateStateFile(e){let t;try{t={...JSON.parse(a.readFileSync(l).toString()),...e}}catch(i){t={...e}}try{a.writeFileSync(l,JSON.stringify(t))}catch(e){}}static readStateFile(){try{return JSON.parse(a.readFileSync(l).toString())}catch(e){return{}}}setNextCheckTimeToEndDate(){h.updateStateFile({nextCheck:this.end})}setLastUrlOpenedTime(){if(new Date>=this.start){const e=new Date,t=new Date(e.setDate(e.getDate()+1));h.updateStateFile({lastUrlOpen:(new Date).getTime(),nextCheck:t})}}deleteStateConfig(){try{a.existsSync(l)&&a.unlinkSync(l)}catch(e){}}dispose(){this.disposable&&this.disposable.dispose(),this.disposed=!0}setNextCheckTime(){const e=new Date,t=new Date(e.setDate(e.getDate()+1));return h.updateStateFile({nextCheck:t}),t}getNextCheckTime(){try{if(a.existsSync(l)){const e=a.readFileSync(l).toString(),t=JSON.parse(e);if(!t.nextCheck)return;return new Date(t.nextCheck)}return}catch(e){this.deleteStateConfig(),this.setNextCheckTimeToEndDate()}}}i.SalesEvent=h},{"./licenseReader":8,fs:void 0,os:void 0,path:void 0,vscode:void 0}],5:[function(e,t,i){"use strict";let s,a;function o(){a.forEach(e=>{try{e(s)}catch(e){}}),a=void 0}Object.defineProperty(i,"__esModule",{value:!0}),i.checkForOffers=void 0,i.checkForOffers=function(t){if(s&&t(s),a)return void a.push(t);a=[t];const i=e("https"),n=JSON.stringify({product:"quokka"}),r={hostname:"x55r2pae4l.execute-api.us-east-1.amazonaws.com",port:443,path:"/Prod/checkOffers",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(n)}},l=i.request(r,e=>{let t="";e.on("data",e=>{t+=e}),e.on("end",()=>{200===e.statusCode&&(s=JSON.parse(t),o())})});l.on("error",e=>{console.error(e),s={},o()}),l.write(n),l.end()}},{https:void 0}],6:[function(e,t,i){"use strict";t.exports=class{constructor(){this._disposables=[]}add(e){e.dispose?this._disposables.push(e):this._disposables.push({dispose:e})}dispose(){this._disposables.forEach(e=>e.dispose())}}},{}],7:[function(e,t,i){"use strict";const s=e("path"),a=e("fs"),o=e("os"),n=e("vscode"),r=e("crypto"),l=global._,c=e("./SalesEvent"),h=e("./InteractiveExamples"),d=global.EventEmitter,u=e("./valueExplorer"),_=e("./traceExplorer"),p=e("./recentFilesExplorer"),g=e("./compositeDisposable"),m=e("./outputBuilder"),v=e("./startViewPanel"),k=n.workspace,f=n.window,S=300,w=3500,C="quokka",y="const chest = require('quokka-treasure-chest')",x="​",T=["showOutput","createFile","newJavaScript","newTypeScript","newRecentInteractive","makeQuokkaFromExistingFile","runOnSave","runOnce","toggle","createJavaScriptFile","createTypeScriptFile",,"openStartView","showInstrumentedFile","stopCurrent","stopAll","installMissingPackageToProject","installMissingPackageToQuokka","installQuokkaPlugin","goToLineInQuokkaFile","showLicense","switchToPro","switchToCommunity","selectWorkspaceFolder","addImport","addRequire","showValue","copyValue","copyExpressionPath","copyExpressionData","profile","clearValue","clearFileValues","enableShowValueOnSelection","disableShowValueOnSelection","enableShowSingleInlineValue","disableShowSingleInlineValue","viewRecentFiles","runRecentFile","removeRecentFiles","disableAutoLog","enableAutoLog","revealInValueExplorer","stopShowingOutputCodeLens","editSessionSettings","debug","debugAutoPlay","playTraceNextStep","playTracePrevStep","playTraceNextStepOut","playTracePrevStepOut","playTraceNextStepOver","playTracePrevStepOver","playTraceForwardToSelection","playTraceBackwardToSelection","playTraceForwardToBreakpoint","playTraceBackwardToBreakpoint","viewCallStack","hideCallStack","openCallStackFrame","revealTraceStep","stopTraceNavigation","autoPlayCode","pauseCodeExecution","viewCodeStory"],b={javascript:".js",javascriptreact:".js",plaintext:".js",typescript:".ts",typescriptreact:".tsx"},D={".js":"javascriptreact",".jsx":"javascriptreact",".ts":"typescript",".tsx":"typescriptreact"},E={automatic:0,onsave:1,once:2};class L extends d{constructor(e){super();let t=this;this._state=e,this._context=e.context,this._statusBar=e.statusBar,this._deactivator=e.deactivate,this._Session=e.coreClient.Session,this._utils=e.coreClient.utils,this._buildDate=e.coreClient.buildDate,this._outputDocumentSelector={language:"quokka-output"},this._setupVersionSpecificComponents(e.version),this._disposables=new g,l.each(T,e=>t._disposables.add(n.commands.registerCommand(`quokka.${e}`,(...i)=>{try{return t[e](...i)}catch(e){console.error(e)}}))),n.commands.executeCommand("setContext","quokka.isLiveShareClient",!1),this._initializeCoverageDecorationTypes(),t._disposables.add(n.workspace.onDidChangeConfiguration(()=>{t._reInitializeCoverageDecorationTypes(),t._activeSessions.forEach(e=>e.output.refreshHeaderCommands())})),this._hideAfterContentDecorationType=f.createTextEditorDecorationType({isWholeLine:!0,after:{margin:"0 0 0 10000px !important"}}),this._debugOutputChannel={appendLine:(e,t)=>{console.log("%c "+e,"color: "+("error"===t?"red":"darkgreen"))}},this._activeSessions=[],this._activeSession=null,this._activeLicenseSession=null,n.commands.executeCommand("setContext","quokka.hasActiveSession",!1),t._disposables.add(k.onDidChangeTextDocument(e=>{if(e&&e.document&&"quokka-output"===e.document.languageId){const t=f.visibleTextEditors.find(t=>t.document===e.document);t&&(t.selection=new n.Selection(0,0,0,0))}})),t._disposables.add(k.onDidOpenTextDocument(e=>{if(e&&e.uri&&"output"===e.uri.scheme){const t=(e,t)=>{if("quokka-output"===e.languageId)return;const i=e.lineAt(0);if(i&&i.text&&i.text.length)return 0===i.text.indexOf(x);t&&t()};t(e,()=>{const i=k.onDidChangeTextDocument(s=>{s.document===e&&(i.dispose(),t(s.document)&&n.languages.setTextDocumentLanguage(e,"quokka-output"))})})&&n.languages.setTextDocumentLanguage(e,"quokka-output")}})),this.outputChannel=this._createOutputChannel(),this.outputChannel.append(x),t._disposables.add(f.onDidChangeActiveTextEditor(e=>{let i=!1;if(e){var s=this._activeSessions.find(t=>e.document===t.textDocument);s&&(this._checkAndSyncSession(s),n.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!0),i=!0,delete s.activeLineNumber,delete s.activeLineNumberCapturedInCodeStoryViewer,s.activeLineNumber=e.selection&&e.selection.active.line,s.activeLineNumberCapturedInCodeStoryViewer=s.traceExplorer.isCodeStoryViewer(e),t._setInlineValuesFileContext(s.hasRemovableMessages),t._setShowValueOnSelectionEnabledContext(s.showValueOnSelection),t._setShowSingleInlineValueEnabledContext(s.showSingleInlineValue),t._setAutoLogEnabledContext(s.autoLog))}i||n.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!1)})),this._setupEnvironment(),n.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!1),this._valueExplorer=new u(this._context),this._recentFilesExplorer=new p(this._quokkaFolder),this._disposables.add(this._recentFilesExplorer),this.on("started",()=>{this._liveShareClientActive()||n.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!0)}),this._previousInlineValuesLineContext=!1,this._previousInlineValuesFileContext=!1,this._automaticRestartActiveTextEditorHandle=void 0,(this._automaticRestart||this._automaticStartRegex)&&f.visibleTextEditors.forEach(e=>{this._checkForAutomaticStart(e)});const i=()=>{this._automaticRestart=n.workspace.getConfiguration().get("quokka.automaticRestart"),this._automaticStartRegex=n.workspace.getConfiguration().get("quokka.automaticStartRegex");try{this._automaticStartRegex&&(this._automaticStartRegex=new RegExp(this._automaticStartRegex))}catch(e){this._automaticStartRegex=""}!this._automaticRestart&&!this._automaticStartRegex||this._automaticRestartActiveTextEditorHandle?this._automaticRestart||this._automaticStartRegex||!this._automaticRestartActiveTextEditorHandle||(this._automaticRestartActiveTextEditorHandle.dispose(),this._automaticRestartActiveTextEditorHandle=void 0):this._automaticRestartActiveTextEditorHandle=f.onDidChangeActiveTextEditor(e=>{this._checkForAutomaticStart(e)})};this._disposables.add(()=>{this._automaticRestartActiveTextEditorHandle&&this._automaticRestartActiveTextEditorHandle.dispose()}),i(),n.workspace.onDidChangeConfiguration&&this._disposables.add(n.workspace.onDidChangeConfiguration(()=>{i()})),this._setupLiveSharing()}static _hash(e){return r.createHash("md5").update(e).digest("hex").substr(0,16)}_checkForAutomaticStart(e){if(e&&e.document&&"file"===e.document.uri.scheme){const t=s.extname(e.document.uri.fsPath);if(!D[t])return;const i=this._activeSessions.find(t=>t.textDocument===e.document);if(this._automaticStartRegex)try{return void(!i&&this._automaticStartRegex.test(e.document.uri.fsPath)&&this.makeQuokkaFromExistingFile())}catch(e){}this._automaticRestart&&(i&&i.mode===E.automatic?this._context.workspaceState.update("quokka:runningstate:"+L._hash(e.document.uri.fsPath),1):this._context.workspaceState.get("quokka:runningstate:"+L._hash(e.document.uri.fsPath))&&this.makeQuokkaFromExistingFile())}}_createOutputChannel(){return f.createOutputChannel("Quokka")}_showOutputChannel(){this.outputChannel.hide(),this.outputChannel.show(!0)}_initializeCoverageDecorationTypes(){this._coverageDecorationTypes={1:this._createCoverageDecorationType("notCovered","log"),2:this._createCoverageDecorationType("covered","log"),3:this._createCoverageDecorationType("partiallyCovered","log"),4:this._createCoverageDecorationType("errorSource","error"),5:this._createCoverageDecorationType("errorPath","log"),6:this._createCoverageDecorationType("notCovered","system"),7:this._createCoverageDecorationType("covered","system"),8:this._createCoverageDecorationType("partiallyCovered","system"),9:this._createCoverageDecorationType("errorSource","error"),10:this._createCoverageDecorationType("errorPath","system")},this._coverageOverrideState=this._currentCoverageOverrideState()}_currentCoverageOverrideState(){const e=n.workspace.getConfiguration();return JSON.stringify([e.get("quokka.lightTheme.log.decorationAttachmentRenderOptions",{}),e.get("quokka.lightTheme.error.decorationAttachmentRenderOptions",{}),e.get("quokka.darkTheme.log.decorationAttachmentRenderOptions",{}),e.get("quokka.darkTheme.error.decorationAttachmentRenderOptions",{})])}_reInitializeCoverageDecorationTypes(){this._coverageOverrideState!==this._currentCoverageOverrideState()&&(this._activeSessions.forEach(e=>{this._clearDecorations(e)}),this._initializeCoverageDecorationTypes(),this._activeSessions.forEach(e=>{this._updateDocuments(e,e.documentUpdates)}))}_liveShareUrlMatches(e,t){if(e.path.startsWith("/~untitled")&&t.path.startsWith("/~untitled")){const t=e.path.split("/"),i=e.path.split("/");return t[t.length-1]===i[i.length-1]}return 0===e.scheme.localeCompare(t.scheme)&&0===e.path.localeCompare(t.path)}async _setupLiveSharing(){const t=e("vsls"),i=await t.getApi();if(!i)return void this._debugOutputChannel.appendLine("Quokka.js Live Share integration disabled, VSLS not found.");if(this._liveShare={api:i},this._liveShare.server=await i.shareService("quokkajs"),this._liveShare.client=await i.getSharedService("quokkajs"),!this._liveShare.server||!this._liveShare.client)return this._debugOutputChannel.appendLine('Could not create a shared service. You have to set "liveshare.features" to "experimental" in your user settings in order to use live sharing.'),void delete this._liveShare;this._disposables.add(()=>i&&i.unshareService("quokkajs"));const s=()=>l.uniq(this._activeSessions.map(e=>({file:e.liveShareFileName,language:e.textDocument.languageId,originalFile:e.textDocument.uri,fileName:e.fileName,documentUpdates:e.documentUpdates,stats:e.stats,mode:e.mode,headerData:e.headerData,liveConsoleOutput:e.allLiveConsoleOutput,status:e.status}))),a=e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.document.uri));if(t){this._start(e.document,e,t.mode);const i=c(t.file);this.processStarted(i),i.output.setHeaderData(t.headerData),i.headerData=t.headerData,t.documentUpdates[t.file.path]=t.documentUpdates[t.fileName],delete t.documentUpdates[t.fileName],this._updateDocuments(i,t.documentUpdates),i.stats=t.stats,i.status=t.status,this.processStats(i),i.liveConsoleOutput=t.liveConsoleOutput,i.liveConsoleOutput&&i.liveConsoleOutput.length&&this._displayLiveConsoleOutput(i,i.liveConsoleOutput),this._liveShare.activeServerSessions=this._liveShare.activeServerSessions.filter(e=>e!==t)}};this._liveShare.api.onDidChangePeers(async e=>{this._liveShareServerActive()&&e.added.length&&(this._liveShare.serverAllowed||this._activeSessions.length&&(f.showWarningMessage("You have not given permission to run Quokka.js in your Live Share Session. All Quokka.js instances have been stopped."),this.stopAll(!0)))}),this._context.subscriptions.push(this._liveShare.server.onDidChangeIsServiceAvailable(async e=>{e?(this._activeSessions.forEach(e=>{e.liveShareFileName=this._getLiveShareFileName(e.textDocument.uri)}),this._liveShare.disposable=new g,this._liveShare.disposable.add(()=>delete this._liveShare.serverAllowed),this._liveShare.serverAllowed=!1,this._activeSessions.length&&this._showLiveShareWarningMessage()):(this._liveShare.disposable&&this._liveShare.disposable.dispose(),delete this._liveShare.disposable)}));const o=async e=>{e?(n.commands.executeCommand("setContext","quokka.isLiveShareClient",!0),n.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!1),this._liveShare.disposable=new g,this._liveShare.disposable.add(()=>delete this._liveShare.activeServerSessions),this._liveShare.disposable.add(f.onDidChangeActiveTextEditor(e=>a(e))),this._liveShare.activeServerSessions=await this._liveShare.client.request("init",[])):(n.commands.executeCommand("setContext","quokka.isLiveShareClient",!0),this._liveShare.disposable&&this._liveShare.disposable.dispose(),delete this._liveShare.disposable)};this._liveShare.client.isServiceAvailable&&o(!0),this._context.subscriptions.push(this._liveShare.client.onDidChangeIsServiceAvailable(o));const r=e=>f.visibleTextEditors.find(t=>this._liveShareUrlMatches(e,t.document.uri)),c=e=>this._activeSessions.find(t=>{if(e.path.startsWith("/~untitled")&&t.fileName.startsWith("/~untitled")){const i=e.path.split("/"),s=t.fileName.split("/");return i[i.length-1]===s[s.length-1]}return t.fileName===e.path});this._liveShare.server.onRequest("init",()=>s()),this._liveShare.client.onNotify("busy",e=>{const t=c(e.file);t&&this.processSessionBusy(t)}),this._liveShare.client.onNotify("stopped",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file));t&&this._liveShare.activeServerSessions.filter(e=>e!==t);const i=c(e.file);i&&(this._stop(i),this._hideStatusIndicator())}),this._liveShare.client.onNotify("started",e=>{const t=r(e.file);if(!t){return void(this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file))||this._liveShare.activeServerSessions.push({file:e.file,originalFile:e.originalFile,fileName:e.fileName,documentUpdates:{},stats:void 0,status:void 0,mode:e.data.mode,headerData:null}))}this._start(t.document,t,e.data.mode);const i=c(e.file);this.processStarted(i)}),this._liveShare.client.onNotify("stats",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file));t&&(t.stats=e.data,delete t.status,delete t.liveConsoleOutput,delete t.allLiveConsoleOutput);const i=c(e.file);i&&(i.stats=e.data,delete i.status,delete i.liveConsoleOutput,delete i.allLiveConsoleOutput,this.processStats(i))}),this._liveShare.client.onNotify("documentUpdates",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(e.file,t.file));t&&(t.documentUpdates=e.data);const i=c(e.file);i&&(e.data[i.fileName]=e.data[e.fileName],delete e.data[e.fileName],this._updateDocuments(i,e.data))}),this._liveShare.client.onNotify("consoleOutput",e=>{const t=c(e.file);t&&this._displayLiveConsoleOutput(t,e.data)}),this._liveShare.client.onNotify("configChanged",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(e.file,t.file));t&&(t.headerData=e.data);const i=c(e.file);i&&(i.output.setHeaderData(e.data),i.headerData=e.data)})}_changePro(e){this._pro=e,n.commands.executeCommand("setContext","quokka.isPro",!!e)}_checkCountry(){const t=parseInt(this._context.globalState.get("quokka.lastCountryCheck","0"),10),i=Date.now();if(i-t>5184e6){e("./checkOffers").checkForOffers(e=>{console.log(e&&e.country),e&&e.country&&(this._context.globalState.update("quokka.country",e.country),this._context.globalState.update("quokka.lastCountryCheck",i.toString()))})}}_setupEnvironment(){this._quokkaFolder=s.join(o.homedir(),".quokka"),this._wallabyFolder=s.join(o.homedir(),".wallaby"),this._lkp=s.join(this._quokkaFolder,".qlc"),this._ol=s.join(this._wallabyFolder,".ol");try{a.existsSync(this._quokkaFolder)||a.mkdirSync(this._quokkaFolder)}catch(e){}try{a.existsSync(this._wallabyFolder)||a.mkdirSync(this._wallabyFolder)}catch(e){}const e=this._loadQuokkaConfig();if(this._changePro(!0===e.pro),this._checkCountry(),this._salesEvent=new c.SalesEvent(this._buildDate,()=>this._treasureHunt()),this._interactiveExamples=new h.InteractiveExamples,this._interactiveExamples.initialize(),v.setController(this),!0!==e.pro&&!1!==e.pro)v.createOrShow(this._context,{type:"firstInstall"});else{v.showWhatsNewIfRequired(this._context);let e=!1;this._disposables.add(f.onDidChangeActiveTextEditor(()=>{if(!e){const t=Date.now(),i=Date.UTC(2022,0,26),s=Date.UTC(2022,1,2);t>=i&&t<=s&&(v.showWhatsNewIfRequired(this._context),e=!0)}}))}}_quokkaConfigPath(){return s.join(this._quokkaFolder,"config.json")}_loadQuokkaConfig(){const e=this._quokkaConfigPath();let t,i={};try{t=a.readFileSync(e).toString(),i=JSON.parse(t)}catch(e){t&&f.showWarningMessage("Looks like your quokka config.json file has invalid syntax, it should be a valid JSON file.")}return i}_saveQuokkaConfig(e){a.writeFileSync(this._quokkaConfigPath(),JSON.stringify(e))}_getThemableDecorationRenderOptions(e,t){const i=e,s=n.workspace.getConfiguration().get(`quokka.${t}Theme.${i}.decorationAttachmentRenderOptions`,{color:"light"===t?"error"===i?"#c80000":"log"===i?"#0000ff":new n.ThemeColor("editorCodeLens.foreground"):"error"===i?"#fe536a":"log"===i?"rgba(86, 156, 214, 1)":new n.ThemeColor("editorCodeLens.foreground"),margin:"1.2em"}),a={};return Object.keys(s).forEach(e=>{null!==s[e]&&(a[e]=s[e])}),delete a.contentText,delete a.contentIconPath,a}_createCoverageDecorationType(e,t){return f.createTextEditorDecorationType({isWholeLine:!0,rangeBehavior:1,gutterIconPath:this._context.asAbsolutePath(s.join("images",e+".svg")).split("\\").join("/"),light:{after:this._getThemableDecorationRenderOptions(t,"light")},dark:{after:this._getThemableDecorationRenderOptions(t,"dark")}})}addImport(e){f.activeTextEditor&&L._addCode(f.activeTextEditor,`import ${e} from '${e}';\n`)}addRequire(e){f.activeTextEditor&&L._addCode(f.activeTextEditor,`const ${e} = require('${e}');\n`)}static _addCode(e,t){const i=new n.WorkspaceEdit;i.insert(e.document.uri,new n.Position(0,0),t),n.workspace.applyEdit(i)}newJavaScript(){this.createJavaScriptFile()}newTypeScript(){this.createTypeScriptFile()}newRecentInteractive(e){this._runIfAllowed(()=>{const t=[...e?["JavaScript","TypeScript"]:[],{label:"Recent Files",recent:!0},...this._interactiveExamples.getExamples()];f.showQuickPick(t).then(e=>{if(!e)return;if(e.recent)return this.viewRecentFiles();let t="",i=e;e.label?(i=this._interactiveExamples.getLanguage(e),t=this._interactiveExamples.getContent(e),this._createLanguageFile(i,t,s.join("interactive-examples",this._interactiveExamples.getRelativeFilePath(e)))):this._createLanguageFile(i,t)})})}createFile(){this.newRecentInteractive(!0)}profile(){this._activeSession&&f.showQuickPick([{label:"Open profile in Chrome Dev Tools",target:"devtools"},{label:"Open profile in VS Code",target:"editor"}]).then(e=>{e&&e.target&&this._activeSession.runTests({profileRun:e.target,file:this._activeSession.fileName})})}editSessionSettings(){if(!this._activeSession)return;const e=this._activeSession,t=e.showValueOnSelection,i=e.showSingleInlineValue,s=[];e.autoLog?s.push({label:"$(symbol-boolean) Toggle Auto Log (Disable)",command:"quokka.disableAutoLog"}):(s.push({label:"$(symbol-boolean) Toggle Auto Log (Enable)",command:"quokka.enableAutoLog"}),t?s.push({label:"$(symbol-boolean) Toggle Show Expression Value on Selection (Disable)",command:"quokka.disableShowValueOnSelection"}):s.push({label:"$(symbol-boolean) Toggle Show Expression Value on Selection (Enable)",command:"quokka.enableShowValueOnSelection"}),i?s.push({label:"$(symbol-boolean) Show All Selected Values",command:"quokka.disableShowSingleInlineValue"}):s.push({label:"$(symbol-boolean) Show Last Selected Value Only",command:"quokka.enableShowSingleInlineValue"})),f.showQuickPick(s).then(t=>{t&&t.command&&(n.commands.executeCommand(t.command),f.showTextDocument(e.textDocument,{preserveFocus:!1}))})}debug({fromTheStart:e=!1}={fromTheStart:!1}){this._activeSession&&(e&&this.stopTraceNavigation(),this._activeSession.runTests({initialTraceRun:!0,file:this._activeSession.fileName,line:e?void 0:this._activeSession.activeLineNumber+1}))}debugAutoPlay(){this._activeSession&&(this._activeSession.runTests({initialTraceRun:!0,file:this._activeSession.fileName,line:this._activeSession.activeLineNumber+1}),this._activeSession.traceExplorer.autoPlayCodeOnStart())}playTraceNextStep(e={}){this._requestTrace(e)}playTraceNextStepOver(){this._requestTrace({over:!0})}playTraceNextStepOut(){this._requestTrace({out:!0})}playTracePrevStep(){this._requestTrace({back:!0})}playTracePrevStepOver(){this._requestTrace({back:!0,over:!0})}playTracePrevStepOut(){this._requestTrace({back:!0,out:!0})}playTraceForwardToSelection(){this._playTraceToSelection()}playTraceBackwardToSelection(){this._playTraceToSelection({back:!0})}playTraceForwardToBreakpoint(){this._requestTrace({breakpoints:this._getBreakpoints()})}playTraceBackwardToBreakpoint(){this._requestTrace({back:!0,breakpoints:this._getBreakpoints()})}_playTraceToSelection(e={}){const t=this._activeSession;if(!t)return;const i=f.activeTextEditor;if(i){if(e.line=t.activeLineNumber+1,e.file=t.fileName,t.traceExplorer.isCodeStoryViewer(i)||t.activeLineNumberCapturedInCodeStoryViewer){const i=t.traceExplorer.getOriginalLocationByCodeStoryLine(e.line);if(!i)return;e.line=i.line,e.file=i.file,e.frame=i.step}this._requestTrace(e)}}_getBreakpoints(e){return e||(e=this._activeSession),n.debug.breakpoints&&e&&e.textDocument?n.debug.breakpoints.filter(t=>t.enabled&&t.location&&t.location.range&&t.location.uri&&t.location.uri.toString()===e.textDocument.uri.toString()).map(t=>({line:t.location.range.start.line+1,file:e.fileName})):[]}_requestTrace(e={}){this._activeSession&&this._activeSession.traceExplorer.requestTrace(e).then(t=>this._processTraceNavigation(this._activeSession,t,!1,e.preserveTimelineSelection))}showOutput(){this._activeSession&&this.outputChannel&&this._showOutputChannel()}createJavaScriptFile(){this._runIfAllowed(()=>this._createLanguageFile("JavaScript"))}createTypeScriptFile(){this._runIfAllowed(()=>this._createLanguageFile("TypeScript"))}makeQuokkaFromExistingFile(){this._runIfAllowed(()=>this._runFromExistingFile(E.automatic))}toggle(){const e=f.activeTextEditor;if(!e)return;const t=e.document;t&&(this._activeSessions.find(e=>e.textDocument===t)?this.stopCurrent():this.makeQuokkaFromExistingFile())}runOnSave(){this._pro?this._runIfAllowed(()=>this._runFromExistingFile(E.onsave)):this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession)}runOnce(){this._pro?this._runIfAllowed(()=>{const e=f.activeTextEditor;if(!e)return;const t=e.document;if(!t)return;const i=this._activeSessions.find(e=>e.textDocument===t);i&&i.mode===E.once?i.changes.length?this._processDocumentContentChange(i,t,[],!0):i.runTests({file:i.fileName}):this._runFromExistingFile(E.once)}):this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession)}stopCurrent(){const e=f.activeTextEditor,t=e&&e.document&&this._activeSessions.find(t=>t.textDocument===e.document)||this._activeSession;t&&this._stop(t,!0)}stopAll(e){this._activeSessions.slice().forEach(t=>this._stop(t,!e))}showInstrumentedFile(){this._activeSession&&this._activeSession.requestInstrumentedFile({path:this._activeSession.fileName},e=>{this._activeSession.output.clearAndRenderHeader(),this._activeSession.output.appendConsoleMessage({text:e,type:"warn"})})}installMissingPackageToProject(){this._installPackage(!0)}installMissingPackageToQuokka(){this._installPackage()}installQuokkaPlugin(e,t){this._installPackage(!1,e,t)}showValue(){this._showValue("show",!0)}copyValue(){this._showValue("copy")}clearValue(){this._clearValues("one")}clearFileValues(){this._clearValues("file")}enableShowValueOnSelection(){this._toggleShowValueOnSelection()}disableShowValueOnSelection(){this._toggleShowValueOnSelection()}enableShowSingleInlineValue(){this._toggleShowSingleInlineValue()}disableShowSingleInlineValue(){this._toggleShowSingleInlineValue()}viewRecentFiles(){return this._recentFilesExplorer.show(this._projectRoot())}runRecentFile(e){const t=s.extname(e.path),i=D[t];i&&(e.runInParentProject?(this._context.globalState.update("quokka:runRecentFile",{...e,runInParentProject:!1}),n.commands.executeCommand("vscode.openFolder",n.Uri.file(e.projectRoot),!0)):e.scratchFile?this._createLanguageFile(i,e.content,e.clone?null:e.id):k.openTextDocument(e.resolvedPath).then(e=>f.showTextDocument(e).then(t=>this._start(e,t,E.automatic))))}async removeRecentFiles({files:e,reloadRecentFilesView:t}){if(await this._recentFilesExplorer.removeRecentFiles(e),t)return this._recentFilesExplorer.show(this._projectRoot())}_toggleAutoLog(){if(this._liveShareClientActive())return;const e=this._activeSession;e&&(e.toggleAutoLog(),e.autoLog=!e.autoLog,this._setAutoLogEnabledContext(e.autoLog))}disableAutoLog(){this._toggleAutoLog()}enableAutoLog(){this._toggleAutoLog()}revealInValueExplorer(e){if(this._liveShareClientActive())return;const t=this._activeSession;if(!t)return;let i=1;e?e.loc&&(i=parseInt((e.loc+"").split(":")[0],10)):i=t.activeLineNumber+1,this._valueExplorer.reveal(t.id,i)}async stopShowingOutputCodeLens(){const e=n.workspace.getConfiguration();await e.update("quokka.showCodeLensInOutputChannel",!1,!0),this._activeSessions.forEach(e=>e.output.refreshHeaderCommands())}_showValue(e,t){const i=f.activeTextEditor;if(!i)return;if(this._liveShareClientActive())return;const s=this._activeSession;if(!s||!s.textDocument)return;const a=i.selection;if(!a||!a.end)return;let o=a.start.line+1,r=a.end.line+1;if(s.traceExplorer.isCodeStoryViewer(i)){this._playTraceToSelection({preserveTimelineSelection:!0,playToExactFrame:!0});const e=s.traceExplorer.getOriginalLocationByCodeStoryLine(o);if(!e)return;const t=r-o;r=(o=e.line)+t}else if(i.document!==s.textDocument)return;const l=s.textDocument.getText();s.evaluateExpressionInEditor(s.fileName,l,[o,a.start.character,r,a.end.character],e),t&&this._scheduleOnResultsAvailable(s.fileName,a.end,()=>n.commands.executeCommand("editor.action.showHover"))}_clearValues(e){const t=this._activeSession;if(!t)return;const i={};if(t.messages&&("file"===e||"one"===e)){const s=f.activeTextEditor;if(!s)return;if(i.path=t.fileName,"one"===e){const e=s.selection;if(!e||!e.active)return;const a=s.selection.active.line;if(i.line=a+1,!t.messages[a]||!t.messages[a].removable)return}if("file"===e&&!t.hasRemovableMessages)return;t.removeLogs(i)}}_toggleShowSingleInlineValue(){if(this._liveShareClientActive())return;const e=this._activeSession;e&&(e.toggleShowSingleInlineValue(),e.showSingleInlineValue=!e.showSingleInlineValue,this._activeSessions.forEach(e=>e.output.refreshHeaderCommands()),this._setShowSingleInlineValueEnabledContext(e.showSingleInlineValue))}_toggleShowValueOnSelection(){if(this._liveShareClientActive())return;const e=this._activeSession;e&&(e.showValueOnSelection=!e.showValueOnSelection,this._activeSessions.forEach(e=>e.output.refreshHeaderCommands()),this._setShowValueOnSelectionEnabledContext(e.showValueOnSelection))}_scheduleOnResultsAvailable(e,t,i){this._runOnResultsAvailable={fileName:e,selectionEnd:t,action:i}}_runScheduledActionOnResultsAvailable(){if(!this._runOnResultsAvailable)return;const e=f.activeTextEditor;if(!e)return;const t=this._activeSession;if(!t||!t.textDocument||e.document!==t.textDocument)return;const i=e.selection;if(i&&i.end&&t.fileName===this._runOnResultsAvailable.fileName&&i.end===this._runOnResultsAvailable.selectionEnd)try{this._runOnResultsAvailable.action()}finally{delete this._runOnResultsAvailable}}copyExpressionPath(e){e&&e.copyExpressionPath()}copyExpressionData(e){e&&e.copyExpressionData()}goToLineInQuokkaFile(e,{reveal:t=!0,select:i=!0,focus:s=!0}={reveal:!0,select:!0,focus:!0}){if(!this._activeSession)return;if(!e)return f.showTextDocument(this._activeSession.textDocument,{preserveFocus:!s});let a,o;return l.isArray(e)?(a=e[0]-1,o=e[1]):(e=e.split(","),a=e[0]-1,o=(e[1]||1)-1),f.showTextDocument(this._activeSession.textDocument,{preserveFocus:!s}).then(e=>{if(!t)return e;const s=new n.Position(a,o);return e.revealRange(new n.Range(s,s)),i?(e.selection=new n.Selection(s,s),e):e})}openStartView(){v.createOrShow(this._context)}_installPackage(e,t,i){if(this._activeSession)if(t)this._activeSession.status="progress",this._updateStatus(this._activeSession,"progress"),this._activeSession.runTests({file:this._activeSession.fileName,installPackage:{name:t,plugin:{editConfig:!0,name:i||t}}});else{if(e&&!this._projectRoot())return void f.showWarningMessage("Cannot install a package into project because quokka is running outside of an opened project.");if(!this._pro)return void this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession);if(!this._activeSession.stats||!this._activeSession.stats.errors)return void f.showWarningMessage("No missing packages to install.");const t=l.find(this._activeSession.stats.errors,e=>e.missingPackage);if(!t||!t.missingPackage)return void f.showWarningMessage("No missing packages to install.");this._activeSession.status="progress",this._updateStatus(this._activeSession,"progress"),this._activeSession.runTests({file:this._activeSession.fileName,installPackage:{name:t.missingPackage,local:e}})}else f.showWarningMessage("Cannot install a package because quokka is not running.")}_setupVersionSpecificComponents(e){const t=e.major,i=e.minor;t>=1&&i>=11&&(this._outputDocumentSelector.scheme="*"),t>=1&&i>=16&&(this._multiFolderWorkspaces=!0)}_createLanguageFile(e,t,i){return e&&k.openTextDocument({language:e.toLowerCase(),content:t||""}).then(e=>f.showTextDocument(e).then(t=>this._start(e,t,E.automatic,i)))}_stop(e,t){if(t&&"file"===e.textDocument.uri.scheme){this._context.workspaceState.get("quokka:runningstate:"+L._hash(e.textDocument.uri.fsPath))&&this._context.workspaceState.update("quokka:runningstate:"+L._hash(e.textDocument.uri.fsPath),0)}e.disposable&&e.disposable.dispose(),this._activeSessions.splice(this._activeSessions.findIndex(t=>t===e),1),this._hideStatusIndicator(),l.isEmpty(this._activeSessions)&&(this.emit("allSessionStopped"),n.commands.executeCommand("setContext","quokka.hasActiveSession",!1)),this._recentFilesExplorer.reset()}_hideStatusIndicator(){this._statusBar.stopProgress(),this._statusBar.hide()}_relativeNormalizedFilePath(e){return this._utils.normalizePath(s.relative(this._projectRoot(),e))}_runFromExistingFile(e){const t=f.activeTextEditor;if(!t)return;const i=t.document;if(!i)return;const s=this._activeSessions.find(e=>e.textDocument===i);s&&this._stop(s),b[i.languageId]?this._start(i,t,e,this._getFileId(i)):"output"===i.uri.scheme&&"quokka-output"===i.languageId?this._activeSession&&!this._activeSession.isDisposed()&&this._start(this._activeSession.textDocument,this._activeSession.editors[0],this._activeSession.mode,this._getFileId(this._activeSession.textDocument)):f.showWarningMessage(`Language "${i.languageId}" is not supported`)}_getFileId(e){if(e)try{const t=c.SalesEvent.readStateFile();if((new Date).getTime()-t.th<11232e5)return~e.getText().indexOf(y)?"treasure-hunt":void 0}catch(e){}}_runIfAllowed(e){!this._liveShareServerActive()||this._liveShare.serverAllowed?e():this._showLiveShareWarningMessage(e)}_showLiveShareWarningMessage(e){f.showWarningMessage("When sharing outside read-only mode, the Quokka.js extension will execute CODE WRITTEN BY OTHERS ON YOUR COMPUTER. Select 'Allow' to continue executing Quokka.js during your Live Share Session.",{title:"Allow",allow:!0},{title:"Deny",allow:!1}).then(t=>{this._liveShare.serverAllowed=!(!t||!t.allow),this._liveShare.serverAllowed?e&&e():this._activeSessions.length&&(f.showInformationMessage("All Quokka.js instances have been stopped."),this.stopAll(!0))})}_liveShareClientActive(){return!!(this._liveShare&&this._liveShare.client&&this._liveShare.client.isServiceAvailable)}_liveShareServerActive(){return!!(this._liveShare&&this._liveShare.server&&this._liveShare.server.isServiceAvailable)}_getLiveShareFileName(e){return"file"===e.scheme?this._liveShare.api.convertLocalUriToShared(e):"untitled"===e.scheme?n.Uri.parse(`vsls:${"/~untitled/"+n.workspace.asRelativePath(e,!1)}`):void 0}_sendToLiveShareClients(e,t,i){this._liveShareServerActive()&&this._liveShare.server.notify(e,{file:t.liveShareFileName,originalFile:t.textDocument.uri,fileName:t.fileName,data:i})}_start(e,t,i,a,o){this._updateConfigurationFromSettings(),L._checkConfigurationSettings();const r=this._liveShareClientActive();if(!0!==o&&!r&&!k.isTrusted){switch(n.workspace.getConfiguration().get("quokka.untrustedWorkspaceBehavior","Prompt to allow")){case"Prompt to allow":return void f.showWarningMessage("You are running in an untrusted workspace. Are you sure you want to start Quokka.js and execute files in this workspace?","Yes","No","Open Settings").then(s=>{"Open Settings"===s?n.commands.executeCommand("workbench.action.openSettings","quokka.untrustedWorkspaceBehavior"):"Yes"===s&&this._start(e,t,i,a,!0)});case"Never allow":return void f.showErrorMessage("Cannot start Quokka.js as it is currently configured to not allow starting in untrusted workspaces.","Open Settings").then(e=>{"Open Settings"===e&&n.commands.executeCommand("workbench.action.openSettings","quokka.untrustedWorkspaceBehavior")})}}const c=r?{}:new this._Session;r&&(c.isDisposed=(()=>!1),c.stop=(()=>{}));const h=new g;if(this._activeSession&&this._activeSession.output.disableChannel(),h.add(()=>{this._sendToLiveShareClients("stopped",c)}),h.add(()=>{this._valueExplorer.remove(c)}),h.add(()=>{delete this._runOnResultsAvailable}),this._watcher||r||(this._watcher=k.createFileSystemWatcher("**/*.*"),this._disposables.add(this._watcher)),r||(h.add(n.languages.registerHoverProvider(e.languageId,{provideHover:(t,i)=>{if(t!==e||l.isEmpty(c.errors))return;const s=(c.errors[i.line]||{}).hover;return s?new n.Hover(s.value):void 0}})),h.add(n.languages.registerCodeActionsProvider(e.languageId,{provideCodeActions:(t,i)=>{if(t!==e||l.isEmpty(c.errors))return;const s=(c.errors[i.start.line]||{}).commands;return s||void 0}}))),c.mode=i,c.disposable=h,c.textDocument=e,c.changes=[],c.fileName=C+b[e.languageId],c.fileId=a,c.documentUpdates={},i===E.automatic&&!r){const e=e=>{c.textDocument.uri.path!==e.path&&"progress"!==c.status&&c.runTests({file:c.fileName,externalFileChange:!0})};h.add(this._watcher.onDidCreate(e)),h.add(this._watcher.onDidChange(e)),h.add(this._watcher.onDidDelete(e))}let d;if("file"===e.uri.scheme){const t=e.uri.path.split("/");d=t[t.length-1]}else if("vsls"===e.uri.scheme){const t=e.uri.path.split("/");d=t[t.length-1]}else d=e.uri.path+b[e.languageId];if(c.id=d,"file"===e.uri.scheme)if(this._projectRoot(e.uri.fsPath)){const t=this._relativeNormalizedFilePath(e.uri.fsPath);t&&(c.fileName=t)}else c.localRoot=s.dirname(e.uri.fsPath),c.fileName=s.basename(e.uri.fsPath);else void 0===c.fileId&&this._recentFilesExplorer.findRecentScratchFileIdByContent(e.getText()).then(e=>{c.fileId=e});this._liveShareServerActive()&&(c.liveShareFileName=this._getLiveShareFileName(e.uri)),"vsls"===e.uri.scheme&&r&&(c.fileName=e.uri.path),c.editors=[t],c.liveConsoleOutput=[],c.allLiveConsoleOutput=[],c.activeLineNumber=t.selection&&t.selection.active.line,this._activeSessions.push(c),n.commands.executeCommand("setContext","quokka.hasActiveSession",!0),h.add(n.debug.onDidChangeBreakpoints(()=>this._updateBreakpointsContext(c))),h.add(k.onDidCloseTextDocument(t=>{e===t&&this._stop(c)})),h.add(k.onDidChangeTextDocument(t=>{e===t.document&&(c.mode===E.automatic?this._processDocumentContentChange(c,t.document,t.contentChanges,!0):(this._hideStatusIndicator(),this._clearDecorations(c),this._processDocumentContentChange(c,t.document,t.contentChanges,!1)))})),h.add(k.onDidSaveTextDocument(t=>{e===t&&c.mode===E.onsave&&this._processDocumentContentChange(c,t,[],!0)})),h.add(f.onDidChangeActiveTextEditor(i=>{const s=c.editors.includes(i);c.editors=c.editors.filter(e=>f.visibleTextEditors.includes(e)),f.visibleTextEditors.filter(t=>t.document===e).forEach(e=>{c.editors.includes(e)||(c.editors.push(e),this._updateDocuments(c,c.documentUpdates),this._highlightActiveTraceStepIfRequired(c,t,{reveal:!c.traceExplorer.isCodeStoryViewer(t)}))}),s&&this._updateDocuments(c,c.documentUpdates),c.editors.length?c.traceExplorer.isActiveCodeStoryViewer(i)&&(this._updateCodeStoryIfRequired(c,i),this._highlightActiveTraceStepIfRequired(c,i,{})):c.traceExplorer.closeCodeStory(!0)})),h.add(f.onDidChangeTextEditorSelection(t=>{if(t&&t.selections&&t.selections.length&&(t.textEditor.document===e||c.traceExplorer.isCodeStoryViewer(t.textEditor))){const e=t.selections[0];if(c.activeLineNumber!==e.active.line){c.activeLineNumber=e.active.line,c.activeLineNumberCapturedInCodeStoryViewer=c.traceExplorer.isCodeStoryViewer(t.textEditor);const i=c.activeLineNumber;this._setInlineValuesLineContext(c.messages&&c.messages[i]&&c.messages[i].removable)}(this._pro&&c.showValueOnSelection&&c.mode===E.automatic||c.traceExplorer.traceBeingNavigated())&&(e.start.line===e.end.line&&e.start.character!==e.end.character||e.start.line===e.end.line-1&&0===e.end.character)&&this._showValue("show")}}));const u=l.bind(this._absoluteFilePath,this);c.output=new m(this.outputChannel,x,c.fileName,u,this._state.coreClient.dmp,c.disposable,this._outputDocumentSelector,!!this._projectRoot(),this._liveShareClientActive(),c.id,this._compactMessageOutput,()=>c.traceExplorer.traceBeingNavigated(),()=>c.traceExplorer.traceBeingAutoPlayed(),()=>c.hasAnyEnabledBreakpointsInActiveEditor,()=>this._pro,()=>n.workspace.getConfiguration().get("quokka.showCodeLensInOutputChannel",!0),()=>c.isCodeStoryEnabled,()=>c.isProfilingEnabled),this._colorizeOutput?c.output.useMarkup():c.output.disableMarkup(),c.traceExplorer=new _(this._context,this,c),this._updateBreakpointsContext(c),r||(c.start({localRoot:this._projectRoot()||c.localRoot,quokkaFolder:this._quokkaFolder,client:"VSCode",cv:n.version,fileName:c.fileName,fileId:c.fileId,editorTypeScript:s.join(process.mainModule.filename,"../../extensions/node_modules/typescript")}),c.on("notification",e=>this._showNotification(e,c)),c.on("busy",()=>{this._sendToLiveShareClients("busy",c),this.processSessionBusy(c)}),c.on("copyToClipboard",e=>{n.env.clipboard.writeText(e.data)}),c.on("stopped",e=>{this._sendToLiveShareClients("stopped",c),this._stop(c),this._hideStatusIndicator(),e.deactivate&&(this.stopAll(!0),this._forceDeactivate())}),c.on("started",()=>{this._sendToLiveShareClients("started",c,{mode:c.mode}),this.processStarted(c)}),c.on("stats",e=>{this._sendToLiveShareClients("stats",c,e),c.stats=e,delete c.status,delete c.liveConsoleOutput,delete c.allLiveConsoleOutput,this.processStats(c),e&&e.messages&&(this._valueExplorer.update(c,e.messages),this._runScheduledActionOnResultsAvailable())}),c.on("live",()=>{c.fileChangedInEditor(c.fileName,c.textDocument.getText(),void 0,void 0,c.fileId),c.fileOpenedInEditor(c.fileName),c.editors.includes(f.activeTextEditor)&&n.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!0)}),c.on("configChanged",e=>{this._changePro(e&&e.pro),n.commands.executeCommand("setContext","quokka.isProfilingEnabled",!!e.profiling),n.commands.executeCommand("setContext","quokka.isCodeStoryEnabled",!!e.codeStory),c.output.setHeaderData(e),c.headerData=e,c.showValueOnSelection=!1!==e.showValueOnSelection,c.showSingleInlineValue=!1!==e.showSingleInlineValue,c.autoLog=!0===e.autoLog,c.isProfilingEnabled=!!e.profiling,c.isCodeStoryEnabled=!!e.codeStory,this._setShowValueOnSelectionEnabledContext(c.showValueOnSelection),this._setShowSingleInlineValueEnabledContext(c.showSingleInlineValue),this._setAutoLogEnabledContext(c.autoLog),this._sendToLiveShareClients("configChanged",c,e)}),c.on("documentUpdates",e=>{this._updateDocuments(c,e),c.traceExplorer.traceBeingNavigated()&&c.traceExplorer.forEachVisibleCodeStoryEditor(t=>c.traceExplorer.updateTimelineEditorInlineValueDecorations(t,c.activeLineNumber+1,e)),this._sendToLiveShareClients("documentUpdates",c,e)}),c.on("consoleError",e=>{e&&e.split("\n").forEach(e=>e&&this._debugOutputChannel.appendLine(`[Error] #${c.id} ${e}`,"error")),c.emit("stats",e)}),c.on("consoleLog",e=>{e&&e.split("\n").forEach(e=>e&&this._debugOutputChannel.appendLine(`[Info]  #${c.id} ${e}`))}),c.on("consoleOutput",e=>{this._sendToLiveShareClients("consoleOutput",c,e),this._displayLiveConsoleOutput(c,e)}),c.on("navigationRequested",e=>this._navigate(e.file,e.loc)),c.on("profileAvailable",e=>{n.commands.executeCommand("vscode.open",n.Uri.file(e.path),-2)}),c.on("traceNavigated",e=>this._processTraceNavigation(c,e)),c.on("traceNavigationReset",()=>this.stopTraceNavigation()),c.on("testTimelineReset",()=>this.closeCodeStory(c))),c.status="progress",this._updateStatus(c,"progress"),h.add(()=>{c.output.dispose(),c.traceExplorer.dispose(),c.stop(),this._clearDecorations(c),delete c.editors,delete c.disposable,delete c.output,c===this._activeSession&&delete this._activeSession,L._clearIdleSessionTimeout(c),this._debugOutputChannel.appendLine(`[Info]  #${c.id} Quokka.js stopped`),this.outputChannel.clear(),this.outputChannel.append(x)}),this.emit("started");const p=this._context.workspaceState.get("quokka:runningstate:"+L._hash(c.textDocument.uri.fsPath));this._automaticRestart&&c.mode===E.automatic?this._context.workspaceState.update("quokka:runningstate:"+L._hash(c.textDocument.uri.fsPath),1):p&&this._context.workspaceState.update("quokka:runningstate:"+L._hash(c.textDocument.uri.fsPath),0)}processStats(e){e.stats&&(L._outputResults(e.output,e.stats),this._processErrors(e)),this._updateStatus(e),L._sessionIsActive(e)}processStarted(e){this._debugOutputChannel.appendLine(`[Info]  #${e.id} Quokka.js started`),n.workspace.getConfiguration().get("quokka.showOutputOnStart",!0)&&(this._liveShareClientActive()?this._liveShare.outputChannelShown||(this._liveShare.outputChannelShown=!0,this._showOutputChannel()):this._showOutputChannel()),this._liveShareClientActive()&&f.showTextDocument(e.textDocument,e.editors&&(e.editors.length||void 0)&&e.editors[0]&&e.editors[0].viewColumn)}processSessionBusy(e){clearTimeout(this._statusUpdateTimeout),this._statusUpdateTimeout=setTimeout(()=>{e.status="progress",this._updateStatus(e,"progress")},S),e.liveConsoleOutput=[],e.allLiveConsoleOutput=[],this._scheduleSessionIdleTimeout(e)}_updateBreakpointsContext(e){e.hasAnyEnabledBreakpointsInActiveEditor=!!this._getBreakpoints(e).length,this._setContext("quokka.hasAnyEnabledBreakpointsInActiveEditor",e.hasAnyEnabledBreakpointsInActiveEditor),this._activeSessions.forEach(e=>e.output.refreshHeaderCommands())}_forceDeactivate(){this._deactivator(),l.each(T,e=>n.commands.registerCommand(`quokka.${e}`,()=>f.showWarningMessage("Please restart VS Code for a new trial session of Quokka.js 'Pro'.")))}_showNotification(e,t){const i=[];if(~e.text.indexOf("expire")&&"warning"===e.type&&this._suppressExpirationNotifications)return;const s=e=>e&&e.url&&n.commands.executeCommand("vscode.open",e.url);if("expiredLicense"===e.id)if(e.invalidVersion){e.text="You are not licensed to use Quokka PRO features for this version of Quokka. As your 12 months of free Quokka updates have expired, this is likely a result of VS Code updating your Quokka extension automatically.",i.push({title:"Renew",url:n.Uri.parse(v.getLicenseDetails().renewUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"}),i.push({title:"Switch to 'Community'",command:"quokka.switchToCommunity"});const t=new Date(e.expiryDate),a="https://quokkajs.com/docs/previous.html?expirydate="+t.getUTCFullYear()+"-"+(t.getUTCMonth()+1)+"-"+t.getUTCDate();i.push({title:"Help / Downgrade",url:n.Uri.parse(a),command:s})}else{e.text="Your Quokka.js 'Pro' license free upgrades period has expired. If you would like to work with the latest version of Quokka.js 'Pro' and future versions released within the next 12 months, please renew your license. If you have already purchased the new license, please activate it.",i.push({title:"Renew",url:n.Uri.parse(v.getLicenseDetails().renewUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"});const t=()=>{n.workspace.getConfiguration().update("quokka.suppressExpirationNotifications",!0,n.ConfigurationTarget.Global)};i.push({title:"Don't show again",command:t})}else e.expiringSoon?e.trial?(e.text="Your Quokka trial period is almost over and finishes on "+e.expirationDateStringFormatted+". If you would like to continue to use Quokka 'PRO', please visit our website to purchase a license.",i.push({title:"Purchase",url:n.Uri.parse(v.getLicenseDetails().purchaseUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"})):(e.text="Your Quokka license free upgrades period expires on "+e.expirationDateStringFormatted+". If you would like to work with the latest version of Quokka and future versions released within the next 12 months, please visit our website to upgrade your license.",i.push({title:"Renew",url:n.Uri.parse(v.getLicenseDetails().renewUrl),command:s}),i.push({title:"Activate",command:"quokka.showLicense"}),i.push({title:"What's New",command:()=>{v.createOrShow(this._context,{type:"showAllWhatsNew"})}})):e.suggestProEdition?(i.push({title:"Switch to 'Pro'",command:()=>{this._switchEdition(!0,t),v.createOrShow(this._context,{type:"goToLicenseSection"})}}),i.push({title:"More info",url:n.Uri.parse("https://quokkajs.com/pro?referrer=VSCode"),command:s})):(~e.text.indexOf("continue-trial-link")?i.push({title:"Continue Trial",command:()=>t&&!t.isDisposed()&&t.continueTrial()}):~e.text.indexOf("extended-trial-license-link")&&i.push({title:"Request License",command:"_requestTrialLicense"}),~e.text.indexOf("activate-link")&&i.push({title:"Activate",command:"quokka.showLicense"}),~e.text.indexOf("purchase")&&(i.push({title:"Purchase",url:n.Uri.parse("https://quokkajs.com/pro?referrer=VSCode"),command:s}),i.push({title:"Switch to 'Community'",command:"quokka.switchToCommunity"})));e.allowMuting&&i.push({title:"Don't show again",command:()=>t&&!t.isDisposed()&&t.muteNotification(e.id)}),e.text=e.text.replace(/<br\/><br\/>/g," ").replace(/<br\/>/g," ").replace(/<[^>]*>/g,"");const a=[e.text].concat(i);f["show"+e.type.charAt(0).toUpperCase()+e.type.substr(1)+("info"===e.type?"rmation":"")+"Message"].apply(f,a).then(this._executeCommand),0===e.text.indexOf("Can not start node.js process")&&f.showInformationMessage('You may use the "node" setting to configure the location of node.',{title:"More info",url:n.Uri.parse("https://quokkajs.com/docs/configuration.html#nodejs-version")}).then(e=>{e&&e.url&&n.commands.executeCommand("vscode.open",e.url)})}_checkAndSyncSession(e){return!!f.visibleTextEditors.find(t=>t.document===e.textDocument)&&(e!==this._activeSession&&(this._activeSession&&(this._activeSession.output.disableChannel(),this._activeSession.traceExplorer.closeCodeStory(!0)),this._activeSession=e,this._updateBreakpointsContext(e),e.output.enableChannel(),e.output.render(),this.processStats(e)),!0)}_requestTrialLicense(){v.createOrShow(this._context,{type:"trial"})}showLicense(){v.createOrShow(this._context,{type:"activate"})}processLicenseChange(e,t){if(l.isUndefined(e))return;let i="";try{i=JSON.parse(Buffer.from(a.readFileSync(this._ol).toString(),"base64").toString())}catch(e){i={}}let r="";try{r=a.readFileSync(this._lkp).toString()}catch(e){}if(/^[a-zA-Z0-9_+&*-]+(?:\.[a-zA-Z0-9_+&*-]+)*@(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,63}$/.test(e)){try{i.quokkaEmail=e.trim(),i.lastUpdate=(new Date).getTime(),a.writeFileSync(this._ol,Buffer.from(JSON.stringify(i)).toString("base64")),this._activeLicenseSession&&(this._activeLicenseSession.stop(),this._activeLicenseSession=null);const o=new this._Session;o.stop=(()=>{o===this._activeLicenseSession&&(this._activeLicenseSession=null)}),o.start({localRoot:this._projectRoot(),quokkaFolder:this._quokkaFolder,client:"VSCode",cv:n.version,fileName:"quokka.js",editorTypeScript:s.join(process.mainModule.filename,"../../extensions/node_modules/typescript"),ol:!0}),o.on("notification",e=>{t({type:"notification",text:e})}),this._activeLicenseSession=o,this.switchToPro()}catch(e){t({type:"error",text:"Unable to save email activation request: "+e.message,items:["Dismiss"]})}return}try{a.unlinkSync(this._ol)}catch(e){}const c=r,h=e||"",d=!!this._parseLicenseKey(c),u=this._parseLicenseKey(h),_=!!u;let p=!1;if(_||!h&&d)try{if(a.writeFileSync(this._lkp,h),u.isBundle){const e=s.join(o.homedir(),".wallaby"),t=s.join(e,"key.lic");a.existsSync(e)||a.mkdirSync(e),a.writeFileSync(t,h)}p=_}catch(e){t({type:"error",text:"Unable to save license key: "+e.message,items:["Dismiss"]}),p=!1}else t({type:"error",text:"The entered license key is not a valid Quokka.js 'Pro' license key.",items:[]});p&&(t({type:"info",text:`Quokka.js 'Pro' is licensed to: ${u.licensee}. Upgrades and updates until: ${u.expiration}.`,items:[]}),this.switchToPro())}_parseLicenseKey(e){if(l.isString(e))try{let t=this._utils.parseKey(e);if(t.licenseeName&&t.expirationDateString&&~t.licensedProduct.indexOf("Quokka"))return{licensee:t.licenseeName,isBundle:0===t.licensedProduct.indexOf("Wallaby.js + Quokka.js"),expiration:t.expirationDateStringFormatted||t.expirationDateString}}catch(e){return}}switchToCommunity(){this._switchEdition(!1,this._activeSession)}switchToPro(){this._switchEdition(!0,this._activeSession)}_treasureHunt(){this._createLanguageFile("JavaScript",`/*_____________________________________________________________________________\n__________  DO YOU HAVE WHAT IT TAKES TO FIND QUOKKA PRO TREASURE?  ___________\n          |                   |                  |                     |\n _________|________________.=""_;=.______________|_____________________|_______\n|                   |  ,-"_,=""     \`"=.|                  |\n|___________________|__"=._o\`"-._        \`"=.______________|___________________\n          |                \`"=._o\`"=._      _\`"=._                     |\n _________|_____________________:=._o "=._."_.-="'"=.__________________|_______\n|                   |    __.--" , ; \`"=._o." ,-"""-._ ".   |\n|___________________|_._"  ,. .\` \` \`\` ,  \`"-._"-._   ". '__|___________________\n          |           |o\`"=._\` , "\` \`; .". ,  "-._"-._; ;              |\n _________|___________| ;\`-.o\`"=._; ." \` '\`."\\\` . "-._ /_______________|_______\n|                   | |o;    \`"-.o\`"=._\`\`  '\` " ,__.--o;   |\n|___________________|_| ;     (#) \`-.o \`"=.\`_.--"_o.-; ;___|___________________\n____/______/______/___|o;._    "      \`".o|o_.--"    ;o;____/______/______/____\n/______/______/______/_"=._o--._        ; | ;        ; ;/______/______/______/_\n____/______/______/______/__"=._o--._   ;o|o;     _._;o;____/______/______/____\n/______/______/______/______/____"=._o._; | ;_.--"o.--"_/______/______/______/_\n____/______/______/______/______/_____"=.o|o_.--""___/______/______/______/____\n/______/______/______/______/______/______/______/______/______/______/______*/\n\n// Welcome to Quokka Pro Treasure Hunt! It only takes a minute to complete,\n// and a very special surprise awaits those who can do it.\n\n// If you get stuck, here's some pointers:\n// Quick Module Install:  https://quokkajs.com/docs/#modules\n// Live Comments:         https://quokkajs.com/docs/#comments\n// Value Explorer:        https://quokkajs.com/docs/#value-explorer\n\n// Good luck and enjoy!\n\n// 1) Fix the error below and install the missing module for the current quokka\n//    file using the link in the Quokka output or in the line hover message\n//    or quick action.\n\n${y}\n\n// 2) So, you have found an old chest, there may be some treasure inside it.\n//    You need to pass a correct string key to the "open" function.\n//    The "open" function returns a clue about how to find the key.\n//    Add Quokka live comment at the end of the line to see the returned value:\n//    chest.open('paste_key_here') //?\n\nchest.open('paste_key_here')\n`,"treasure-hunt")}_switchEdition(e,t){const i=this._loadQuokkaConfig();if(i.pro=e,this._changePro(e),this._saveQuokkaConfig(i),!this._liveShareClientActive()&&t&&!t.isDisposed()){const e=t.textDocument,i=t.editors[0];this.stopAll(!0),t.mode!==E.automatic&&t.mode!==E.onsave||this._start(e,i,t.mode)}}_processErrors(e){this._liveShareClientActive()||e.stats.errors&&(e.errors={},L._addError(e,L._createLineDataObject(e,e=>e.missingPackage,e=>[{title:`Install "${e.missingPackage}" package for the current quokka file`,command:"installMissingPackageToQuokka"},this._projectRoot()&&{title:`Install "${e.missingPackage}" package into the project`,command:"installMissingPackageToProject"}])),L._addError(e,L._createLineDataObject(e,e=>e.missingBrowserGlobal,e=>[{title:`"${e.missingBrowserGlobal}" looks like a browser global`},{title:"Install and use quokka browser plugin",command:"installQuokkaPlugin",args:["jsdom","jsdom-quokka-plugin"]}])),L._addError(e,L._createLineDataObject(e,e=>e.undefinedName,e=>[{title:`Add "import ${e.undefinedName} from '${e.undefinedName}';"`,command:"addImport",arg:e.undefinedName},{title:`Add "const ${e.undefinedName} = require('${e.undefinedName}');"`,command:"addRequire",arg:e.undefinedName}])))}static _addError(e,t){t&&(e.errors[t.line]=t)}static _createHoverObject(e){return e.filter(e=>!!e).map(e=>e.command?`\n[${e.title}](${encodeURI(`command:quokka.${e.command}${e.arg?"?"+JSON.stringify(e.arg):""}`)})`:e.title).join("\n")}static _createCommands(e){return e.filter(e=>e&&e.command).map(e=>({title:e.title,command:`quokka.${e.command}`,arguments:e.args?e.args:e.arg?[e.arg]:void 0}))}static _createLineDataObject(e,t,i){const s=e.stats.errors.find(t),a=s&&s.stack||[];if(a.reverse(),a.length){const t=l.find(a,t=>t.file===e.fileName);if(t&&t.loc&&t.loc.split){const e=i(s);let a=L._createHoverObject(e);return n.MarkdownString&&((a=new n.MarkdownString(a)).isTrusted=!0),{line:parseInt(t.loc.split(":")[0],10)-1,hover:{value:a},commands:L._createCommands(e)}}}}static _checkConfigurationSettings(){try{let e=n.workspace.getConfiguration();if(e){e.get("quokka.suppressGlyphMarginNotifications",!1)||e.get("editor.glyphMargin",!0)||f.showWarningMessage("Quokka.js will not display coverage indicators in the gutter because the `editor.glyphMargin` setting is set to `false`. You can hide this message by setting `quokka.suppressGlyphMarginNotifications` to `false`.")}}catch(e){}}_updateConfigurationFromSettings(){let e="",t=!1;try{var i=this._loadQuokkaConfig();e=i.node,i.useWsl&&(t=i.useWsl)}catch(e){}try{process.env.WALLABY_USE_WSL=t;const i=n.workspace.getConfiguration();if(i){this._suppressExpirationNotifications=i.get("quokka.suppressExpirationNotifications",!1),this._colorizeOutput=i.get("quokka.colorizeOutput",!0),this._compactMessageOutput=i.get("quokka.compactMessageOutput",!1);const t=i.get("quokka.node",e);t?process.env.WALLABY_NODE=t:delete process.env.WALLABY_NODE}}catch(e){}}activate(){let e;this._onceDocumentStopsChanging=l.debounce(l.bind(this._onceDocumentStopsChanging,this),100),L._outputResults=l.debounce(l.bind(L._outputResults,this),100),this._statusBar.updateText=l.debounce(l.bind(this._statusBar.updateText,this._statusBar),200),this._executeCommand=l.bind(this._execute,this),this._statusBar.command="quokka.showOutput",this._disposables.add(()=>{if(this._statusBar&&this._statusBar.hide(),this._activeLicenseSession)try{this._activeLicenseSession.stop(),this._activeLicenseSession=null}catch(e){}this._activeSessions.forEach(e=>e.disposable.dispose()),this._activeSessions.length=0,n.commands.executeCommand("setContext","quokka.hasActiveSession",!1)});const t=()=>{try{const i=this._context.globalState.get("quokka:runRecentFile");i&&p.pathToMetadataKey(i.projectRoot)===p.pathToMetadataKey(this._projectRoot())&&(this._context.globalState.update("quokka:runRecentFile",void 0),this.runRecentFile(i))}finally{e=setTimeout(t,1e3)}};t(),this._disposables.add(()=>{clearTimeout(e)})}_projectRoot(e){if(e&&this._multiFolderWorkspaces&&k.workspaceFolders&&k.workspaceFolders.length){const t=l.find(k.workspaceFolders,t=>~e.indexOf(t.uri.fsPath+s.sep));if(t)return this._currectProjectRoot=t.uri.fsPath,this._currectProjectRoot}if(this._currectProjectRoot)if(this._multiFolderWorkspaces&&k.workspaceFolders){const e=l.find(k.workspaceFolders,e=>this._currectProjectRoot===e.uri.fsPath);if(e)return e.uri.fsPath}else if(k.rootPath&&this._currectProjectRoot===k.rootPath)return k.rootPath;return this._multiFolderWorkspaces&&k.workspaceFolders?k.workspaceFolders.length?k.workspaceFolders[0].uri.fsPath:void 0:k.rootPath||""}selectWorkspaceFolder(){this._multiFolderWorkspaces&&k.workspaceFolders&&k.workspaceFolders.length>1&&f.showWorkspaceFolderPick&&f.showWorkspaceFolderPick().then(e=>{e&&(this._currectProjectRoot=e.uri.fsPath)})}deactivate(){this._disposables.dispose()}static _sessionIsActive(e){L._clearIdleSessionTimeout(e)}_sessionIsIdle(e){this._clearDecorations(e),delete e.stats,e.liveConsoleOutput&&!e.liveConsoleOutput.started&&e.output.clearAndRenderHeader()}static _clearIdleSessionTimeout(e){e.idleTimeout&&(clearTimeout(e.idleTimeout),delete e.idleTimeout)}_clearDecorations(e){e.editors.forEach(e=>{l.each(this._coverageDecorationTypes,t=>e.setDecorations(t,[])),e.setDecorations(this._hideAfterContentDecorationType,[])})}_scheduleSessionIdleTimeout(e){L._clearIdleSessionTimeout(e),e.idleTimeout=setTimeout(()=>this._sessionIsIdle(e),w)}_displayLiveConsoleOutput(e,t){if(!e.liveConsoleOutput)return;const i=e.liveConsoleOutput.started;e.liveConsoleOutput=e.liveConsoleOutput.concat(t),e.liveConsoleOutput.started=i,e.liveConsoleOutput.started?e.displayLiveConsoleOutputTimeout||this._displayPendingLiveConsoleOutput(e):(e.liveConsoleOutput.started=!0,e.displayLiveConsoleOutputTimeout=setTimeout(()=>{delete e.displayLiveConsoleOutputTimeout,e.liveConsoleOutput&&e.liveConsoleOutput.length&&(e.output.clearAndRenderHeader(),this._displayPendingLiveConsoleOutput(e))},150))}_displayPendingLiveConsoleOutput(e){e.allLiveConsoleOutput=e.allLiveConsoleOutput.concat(e.liveConsoleOutput),e.liveConsoleOutput.forEach(t=>e.output.appendConsoleMessage(t)),e.liveConsoleOutput.length=0}_execute(e){if(e&&e.command)return"function"==typeof e.command?e.command(e):~e.command.indexOf("quokka.")?n.commands.executeCommand(e.command):this[e.command]()}_processDocumentContentChange(e,t,i,s){e.isDisposed()||t&&t.uri&&t.uri.scheme&&"file"!==t.uri.scheme&&"untitled"!==t.uri.scheme&&"vsls"!==t.uri.scheme||(e.changes=e.changes.concat(i),this._hideMessagesForChangedRanges(e.changes),s&&this._onceDocumentStopsChanging(e,t))}_onceDocumentStopsChanging(e,t){!e.isDisposed()&&e.changes.length&&(this._liveShareClientActive()||(clearTimeout(this._statusUpdateTimeout),this._statusUpdateTimeout=setTimeout(()=>{e.status="progress",this._updateStatus(e,"progress")},S),e.fileChangedInEditor(e.fileName,t.getText(),{start:l.chain(e.changes).map(e=>e.range.start.line).min().value()+1,end:l.chain(e.changes).map(e=>e.range.end.line).max().value()+1},!1,e.fileId),e.changes=[]))}_updateStatus(e){if(e.isDisposed())return;let t,i=e.status;clearTimeout(this._statusUpdateTimeout),i||(i=l.isString(e.stats)?"failing":e.stats?e.stats.errors.length?"failing":"passing":"failing",t=e.stats&&e.stats.time),i&&("progress"===i?this._statusBar.displayProgress():(this._statusBar.stopProgress(),this._statusBar.setMainText(("failing"===i?"✗":"✔")+(t?` ${t}ms`:"")),this._statusBar.updateText()),this._statusBar.show()),this._checkAndSyncSession(e)}_updateStatusExtension(e){this._statusBar.setExtensionText(e),this._statusBar.updateText()}_removeStatus(){this._statusBar.hide()}_updateDocuments(e,t){if(e.isDisposed())return;if(e.changes.length&&!this._liveShareClientActive())return;e.documentUpdates=t;const i=f.activeTextEditor&&f.activeTextEditor.selection;let s=void 0,a=!1;i&&i.active&&(s=i.active.line),l.each(f.visibleTextEditors,i=>{if(!i)return;const o=i.document;if(o!==e.textDocument)return;e.hasRemovableMessages=!1,e.messages=Object.create(null);const r=t[e.fileName];if(!r||!r.lines)return;const c={1:[],2:[],3:[],4:[],5:[],6:[],7:[],8:[],9:[],10:[]};l.each(r.lines,t=>{const i=t.num-1;if(i<0||i>=o.lineCount)return;const r=o.lineAt(i);if(!r)return;const l=t.meta||{},h={range:new n.Range(r.lineNumber,r.firstNonWhitespaceCharacterIndex,r.lineNumber,r.range.end.character)},d=t.err||t.log,u=t.longLog||d;if(u&&(h.hoverMessage=n.MarkdownString?new n.MarkdownString("```\n"+u+"\n```"):{value:u}),c[t.state+(t.meta&&t.meta.system?5:0)].push(h),d&&(h.renderOptions={after:{contentText:d}},t.log)){const t=l.log&&l.log.removable;e.messages[r.lineNumber]={removable:t},t&&(e.hasRemovableMessages=!0,r.lineNumber===s&&(a=!0))}}),l.each(c,(e,t)=>i.setDecorations(this._coverageDecorationTypes[t],e)),this._scheduleHiddenMessagesDisplay()}),f.activeTextEditor&&e.textDocument===f.activeTextEditor.document&&(this._setInlineValuesLineContext(a),this._setInlineValuesFileContext(e.hasRemovableMessages))}_hideMessagesForChangedRanges(e){clearTimeout(this._displayHiddenMessagesTimeout),this._messagesHiddenAt=+new Date,f.activeTextEditor&&f.activeTextEditor.setDecorations(this._hideAfterContentDecorationType,e.map(e=>({range:new n.Range(e.range.start.line,0,e.range.end.line,Number.MAX_SAFE_INTEGER)})))}_scheduleHiddenMessagesDisplay(){let e=this;clearTimeout(this._displayHiddenMessagesTimeout);let t=this._messagesHiddenAt?+new Date-this._messagesHiddenAt:400;this._displayHiddenMessagesTimeout=setTimeout(()=>{try{l.each(f.visibleTextEditors,t=>t&&t.setDecorations(e._hideAfterContentDecorationType,[]))}catch(e){}},Math.max(0,500-t))}_navigate(e,t,{reveal:i=!0,select:s=!0,focus:a=!0}={reveal:!0,select:!0,focus:!0}){if(!e)return;if(this._activeSession&&e===this._activeSession.fileName)return this.goToLineInQuokkaFile(t,{reveal:i,select:s,focus:a});let o,r,c=this._absoluteFilePath(e);return l.isNumber(t)?o=t:l.isArray(t)?(o=t[0],r=t[1]):l.isString(t)&&(t=t.split(":"),o=t[0]&&parseInt(t[0],10),r=t[1]&&parseInt(t[1],10)),l.isNumber(o)?o-=1:o=0,l.isNumber(r)||(r=0),k.openTextDocument(c).then(e=>f.showTextDocument(e,{preserveFocus:!a})).then(e=>{if(!i)return e;if(!r){const t=e.document&&e.document.lineAt(o);t&&(r=t.firstNonWhitespaceCharacterIndex)}let t=new n.Position(o,r);return e.revealRange(new n.Range(t,t),2),s?(e.selection=new n.Selection(t,t),e):e})}_processTraceNavigation(e,t,i=!0,s=!1){t&&t.restart&&(i=!1),l.each(f.visibleTextEditors,t=>e.traceExplorer.destroyStackTraceDecorations(t));const{decorationType:a,step:o}=e.traceExplorer.traceNavigated(t);if(this._updateStatus(e),a)return this._navigateWithTraceHighlight(e,o,a,{onlyHighlightRangeInVisibleEditors:i,preserveTimelineSelection:s,requestTimelineIfStepIsOutOfSight:!0})}_highlightActiveTraceStepIfRequired(e,t,{reveal:i=!1,onlyHighlightRangeInVisibleEditors:s=!0}){if(t&&e.traceExplorer.traceBeingNavigated()){const a=e.traceExplorer.lastActiveStep();a&&t.document&&this._navigateWithTraceHighlight(e,a,e.traceExplorer.activeTraceFrameDecorationType(),{reveal:i,onlyHighlightRangeInVisibleEditors:s})}}stopTraceNavigation(){const e=this._activeSession;e&&(e.traceExplorer.stopTraceNavigation(),e.traceExplorer.closeCodeStory(!0),this._updateStatus(e))}viewCallStack(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&e.traceExplorer.requestCallStack()}hideCallStack(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&(e.traceExplorer.hideCallStack(),e.stats&&e.stats.trace&&(delete e.stats.trace.callStack,this.processStats(e)))}openCallStackFrame(e){const t=this._activeSession;t&&t.traceExplorer.traceBeingNavigated()&&(l.each(f.visibleTextEditors,e=>t.traceExplorer.destroyStackTraceDecorations(e)),this._navigateWithTraceHighlight(t,e,t.traceExplorer.activeTraceCallStackFrameDecorationType(),{requestTimelineIfStepIsOutOfSight:!0}),t.traceExplorer.updateTraceContextCallStackFrame(e))}revealTraceStep(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&e.editors.forEach(t=>{this._highlightActiveTraceStepIfRequired(e,t,{reveal:!0,onlyHighlightRangeInVisibleEditors:!1})})}async viewCodeStory(e={},t){if(t=t||this._activeSession){if(!t.traceExplorer.traceBeingNavigated())return this._openCodeStoryOnTraceNavigationStarted(t,e),void this.debug();await t.traceExplorer.viewCodeStory(e),t.traceExplorer.forEachVisibleCodeStoryEditor(e=>{this._highlightActiveTraceStepIfRequired(t,e,{reveal:!0,onlyHighlightRangeInVisibleEditors:!0})})}}_openCodeStoryOnTraceNavigationStarted(e,t){const i=e.traceExplorer.onTraceNavigationStarted(()=>{i.dispose(),this.viewCodeStory(t,e)})}closeCodeStory(e){e.traceExplorer.closeCodeStory()}_updateCodeStoryIfRequired(e,t){if(e.traceExplorer.isActiveCodeStoryViewer(t)&&!e.traceExplorer.updateCodeStoryIfLoaded(t)&&e.traceExplorer.traceBeingNavigated()){const t=e.traceExplorer.lastActiveStep();this.viewCodeStory({before:t&&t.frame})}}autoPlayCode(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&(e.traceExplorer.autoPlayCode(),this._activeSessions.forEach(e=>e.output.refreshHeaderCommands()))}pauseCodeExecution(){const e=this._activeSession;e&&e.traceExplorer.traceBeingNavigated()&&(e.traceExplorer.pauseCodeExecution(),this._activeSessions.forEach(e=>e.output.refreshHeaderCommands()))}_navigateWithTraceHighlight(e,t,i,{onlyHighlightRangeInVisibleEditors:s=!1,reveal:a=!0,requestTimelineIfStepIsOutOfSight:o=!1,preserveTimelineSelection:r=!1}){const l=(e,s)=>{const a=t.range[0]!==t.range[2],o=s>=0?s:t.range[0]-1,r=e.document&&e.document.lineAt(o),l=t.range[1],c=!l&&r?r.firstNonWhitespaceCharacterIndex:l;a?e.setDecorations(i,[new n.Range(o,c,o,1e4)]):e.setDecorations(i,[new n.Range(o,c,o,t.range[3])])};if(e.traceExplorer.anyVisibleCodeStoryEditors()){const i=e.traceExplorer.getCodeStoryLineByStep(t.frame);if(i>=0?(a&&e.traceExplorer.forEachVisibleCodeStoryEditor(e=>{let s=new n.Position(i,t.range[1]);e.revealRange(new n.Range(s,s),2),r||(e.selection=new n.Selection(s,s))}),e.traceExplorer.forEachVisibleCodeStoryEditor(e=>l(e,i))):(e.traceExplorer.forEachVisibleCodeStoryEditor(t=>e.traceExplorer.destroyStackTraceDecorations(t)),o&&this.viewCodeStory({before:t.frame,reveal:!0})),e.traceExplorer.isCodeStoryViewer(f.activeTextEditor))return this._navigate(t.file,t.loc,{reveal:a&&!s,select:!1,focus:!1}).then(l)}return this._navigate(t.file,t.loc,{reveal:a&&!s,select:!s}).then(l)}_absoluteFilePath(e){const t=this._activeSession&&this._activeSession.localRoot;return s.resolve(this._projectRoot()||t,e)}_setInlineValuesLineContext(e){e=!!e,this._previousInlineValuesLineContext!==e&&(this._previousInlineValuesLineContext=e,this._setContext("quokka.lineHasRemovableInlineValues",e))}_setInlineValuesFileContext(e){e=!!e,this._previousInlineValuesFileContext!==e&&(this._previousInlineValuesFileContext=e,this._setContext("quokka.fileHasRemovableInlineValues",e))}_setShowSingleInlineValueEnabledContext(e){this._setContext("quokka.showSingleInlineValueEnabled",e)}_setShowValueOnSelectionEnabledContext(e){this._setContext("quokka.showValueOnSelectionEnabled",e)}_setAutoLogEnabledContext(e){this._setContext("quokka.autoLogEnabled",e)}_setContext(e,t){n.commands.executeCommand("setContext",e,t)}static _outputResults(e,t,i){let s,a=e.lines();e.build(t);let o=e.lines();if(!(s=i||o.length!==a.length))for(let t=0,i=o.length;t<i;t++)if(e.areDifferent(o[t],a[t])){s=!0;break}s&&e.render()}}t.exports=L},{"./InteractiveExamples":3,"./SalesEvent":4,"./checkOffers":5,"./compositeDisposable":6,"./outputBuilder":9,"./recentFilesExplorer":10,"./startViewPanel":11,"./traceExplorer":12,"./valueExplorer":13,crypto:void 0,fs:void 0,os:void 0,path:void 0,vscode:void 0,vsls:void 0}],8:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.LicenseReader=void 0;const s=e("fs"),a=e("os"),o=e("path");class n{static getLicenseDetails(e){let t;try{t=s.statSync(n.startPage).mtimeMs}catch(e){t=(new Date).getTime()}const i={state:"demoLicense",productType:"",registeredTo:"",expiryDate:"",email:"",daysUntilExpiry:"",isBundle:!1,upgradeUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",purchaseUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",renewUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",previousVersionUrl:"https://quokkajs.com/docs/previous.html",newInstall:!1,installTime:t};try{JSON.parse(s.readFileSync(n.quokkaConfigPath).toString()).pro||(i.state="community")}catch(e){i.newInstall=!0,i.state="community"}if("community"===i.state)return i;try{const e=JSON.parse(Buffer.from(s.readFileSync(n.olp).toString(),"base64").toString());i.email=e.quokkaEmail||"",i.registeredTo=i.email,i.onlineLicense=!!e.quokkaEmail,i.state="activating"}catch(e){}try{const t=s.readFileSync(n.lkp).toString().split(":").reduce((e,t)=>t.trim());if(t.length<50){if(!i.onlineLicense)try{parseInt(t,10)+1314e6<+new Date&&(i.state="trialDemoOver")}catch(e){i.state="trialDemoOver"}}else{const s=Buffer.from(t,"base64").toString().split("\n"),[a,o,,,r,l]=s[1].split(",");i.registeredTo=s[0],i.email=i.email||a,i.isBundle=!!~o.indexOf("Wallaby.js");const c=!!~o.toLowerCase().indexOf("company")||!!~o.toLowerCase().indexOf("enterprise"),h="wallabyjs@gmail.com"===a||"1"===l;i.isBundle?i.productType="Wallaby.js + Quokka.js":i.productType="Quokka.js";const[d,u,_]=s[2].split("/").map(e=>parseInt(e,10));i.expiryDate=d+" "+n.monthNames[u-1]+", "+_;let p=!1;const g=new Date(Date.UTC(_,u-1,d)),m=new Date,v=Math.floor((g.getTime()-m.getTime())/864e5);i.daysUntilExpiry=`${v} day${1===v?"":"s"}`,v<0?h?i.state="trialDemoOver":(e.setHours(0,0,0,0),g.setHours(0,0,0,0),g<e?(i.previousVersionUrl="https://quokkajs.com/docs/previous.html?expirydate="+g.getUTCFullYear()+"-"+(g.getUTCMonth()+1)+"-"+g.getUTCDate(),i.state="expiredWrongVersion",i.key=t,p=!0):(i.state="expired",i.key=t,p=!0)):v<=14?h?i.state="trialLicense":(i.state="expiring",i.key=t,p=!0):h?i.state="trialLicense":(i.state="activated",i.key=t,p=!0),p&&!c&&(c?(i.purchaseUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka",r?(i.upgradeUrl=`https://wallabyjs.com/store/personal/?renewalOrder=${r}&upgrade=1&referrer=qsp`,i.renewUrl=`https://wallabyjs.com/store/personal/?renewalOrder=${r}&referrer=qsp`):(i.upgradeUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka",i.renewUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka")):(i.upgradeUrl=`https://wallabyjs.com/store/personal/?renewalEmail=${encodeURIComponent(a)}&upgrade=1&referrer=qsp`,i.renewUrl=`https://wallabyjs.com/store/personal/?renewalEmail=${encodeURIComponent(a)}&referrer=qsp`))}}catch(e){}return i}}i.LicenseReader=n,n.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],n.quokkaFolder=o.join(a.homedir(),".quokka"),n.wallabyFolder=o.join(a.homedir(),".wallaby"),n.lkp=o.join(n.quokkaFolder,".qlc"),n.quokkaConfigPath=o.join(n.quokkaFolder,"config.json"),n.olp=o.join(n.wallabyFolder,".ol"),n.startPage=o.join(n.quokkaFolder,"startPage.json")},{fs:void 0,os:void 0,path:void 0}],9:[function(e,t,i){"use strict";const s=e("vscode"),a=global._,o={none:"",link:Array(2).join("​"),empty:Array(6).join("​"),error:{start:"",end:" "},context:Array(4).join("​"),header:Array(5).join("​"),string:{start:"",end:" "},diff:Array(7).join("​"),diffIns:Array(2).join("⁠"),diffDel:Array(2).join("‍"),tmpDiffIns:{start:"wsDiffIns",end:"weDiffIns"},tmpDiffDel:{start:"wsDiffDel",end:"weDiffDel"}};t.exports=class{constructor(e,t,i,o,n,r,l,c,h,d,u,_,p,g,m,v,k,f){const S=this;this._prefix=t,this._lines=[],this._codeLens=[],this._links=[],this._quokkaFileName=i,this._displayedFileName=d,this._contentLimit=1048576,this._channel=e,this._absolutePathResolver=o,this._dmp=n,this._hasOpenedProject=c,this.render=a.debounce(a.bind(this.render,this),300),this._header="Quokka",this.isLiveShareClient=h,this.disposed=!1,this.channelEnabled=!0,this._messageSeparator=u?"":"\n",this._isProVersion=m,this._isCodeStoryEnabled=k,this._isProfilingEnabled=f,this._hasAnyEnabledBreakpointsInActiveEditor=g,this._isTraceBeingNavigated=_,this._isTraceBeingAutoPlayed=p,this._getShowCodeLensInOutputChannelSetting=v,this._onDidChangeCodeLenses=new s.EventEmitter,this._replaceApiAvailable=!0,this.useMarkup(),r.add(s.languages.registerDocumentLinkProvider(l,{provideDocumentLinks:e=>{if(!S.channelEnabled||S.disposed)return[];const t=e.lineAt(0);return t&&t.text&&~t.text.indexOf(this._header)?this._links:[]}}));let w=s.languages.registerCodeLensProvider(["quokka-output"],{onDidChangeCodeLenses:this._onDidChangeCodeLenses.event,provideCodeLenses:e=>(w&&S.disposed&&(w.dispose(),w=null),!S.channelEnabled||S.disposed?[]:S._activeCodeLens||[])})}enableChannel(){this.channelEnabled=!0,this._refreshCodeLens()}disableChannel(){this.channelEnabled=!1,this._refreshCodeLens(!0)}useMarkup(){this._markupTokens=a.extend({},o)}disableMarkup(){this._markupTokens.none=this._markupTokens.link=this._markupTokens.empty=this._markupTokens.error=this._markupTokens.context=this._markupTokens.header=this._markupTokens.string=this._markupTokens.diff=""}dispose(){this.clear(),this.disposed=!0}build(e){if(this._lines=[],this._links=[],this._codeLens=[],delete this._callStackDisplayed,this._appendLine("none",0,this._header),a.isString(e))this._appendLine("error",0,e);else if(a.isObject(e)){if(this._isTraceBeingNavigated()&&e.trace){const t=Math.floor((e.trace.currentFrame+1)/e.trace.length*100);if(this._traceNavigationProgress!==t&&(this._traceNavigationProgress=t,this._refreshCodeLens()),e.trace.callStack){const t=e.trace.callStack[e.trace.currentFrame];t&&t.stack&&(this._outputCallStack(t.stack),this._callStackDisplayed=!0)}}a.each(e.errors,e=>this._outputError(e)),a.each(e.messages,e=>this._outputMessage(e))}}_headerCodeLens(){const e=[];return this._isTraceBeingNavigated()?(e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:`Execution progress: ${a.pad(this._traceNavigationProgress,3,"ㅤ")}%ㅤ`,tooltip:"Reveal Active Frame",command:"quokka.revealTraceStep"})),this._isTraceBeingAutoPlayed()?e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-pause) Pause Code Execution",tooltip:"Pause Code Execution",command:"quokka.pauseCodeExecution"})):(e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-reverse-continue)ㅤ",tooltip:"Run Back to Active Line",command:"quokka.playTraceBackwardToSelection"})),this._hasAnyEnabledBreakpointsInActiveEditor()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(circle-filled)ㅤ",tooltip:"Run Back to Breakpoint",command:"quokka.playTraceBackwardToBreakpoint"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-out)ㅤ",tooltip:"Step Back Out",command:"quokka.playTracePrevStepOut"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-into)ㅤ",tooltip:"Step Back Into",command:"quokka.playTracePrevStep"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-back)ㅤ",tooltip:"Step Back Over",command:"quokka.playTracePrevStepOver"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-restart)ㅤ",tooltip:"Restart Time Machine From The First Executed Line",command:"quokka.debug",arguments:[{fromTheStart:!0}]})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-stop)ㅤ",tooltip:"Stop Time Machine",command:"quokka.stopTraceNavigation"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-alt)ㅤ",tooltip:"Auto Play Code",command:"quokka.autoPlayCode"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-over)ㅤ",tooltip:"Step Over",command:"quokka.playTraceNextStepOver"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-into)ㅤ",tooltip:"Step Into",command:"quokka.playTraceNextStep"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-step-out)ㅤ",tooltip:"Step Out",command:"quokka.playTraceNextStepOut"})),this._hasAnyEnabledBreakpointsInActiveEditor()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(circle-filled)ㅤ",tooltip:"Run to Breakpoint",command:"quokka.playTraceForwardToBreakpoint"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-continue)ㅤ",tooltip:"Run to Active Line",command:"quokka.playTraceForwardToSelection"})),this._callStackDisplayed||e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(list-selection)ㅤ",tooltip:"View Current Call Stack",command:"quokka.viewCallStack"})),this._isProVersion()&&this._isCodeStoryEnabled()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-line-by-line) View Code Story",tooltip:"View Code Story",command:"quokka.viewCodeStory"})))):(e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"$(debug-alt)ㅤ",tooltip:"Start Time Machine With Auto Play",command:"quokka.debugAutoPlay"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug)ㅤ",tooltip:"Start Time Machine",command:"quokka.debug"})),this._isProVersion()&&this._isCodeStoryEnabled()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(debug-line-by-line)ㅤ",tooltip:"View Code Story",command:"quokka.viewCodeStory"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(files)ㅤ",tooltip:"View Recent Quokka Files",command:"quokka.viewRecentFiles"})),this._isProVersion()&&(this._isProfilingEnabled()&&e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(watch)ㅤ",tooltip:"View CPU Profile",command:"quokka.profile"})),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(settings)ㅤ",tooltip:"Edit Current Quokka Session Settings",command:"quokka.editSessionSettings"}))),e.push(new s.CodeLens(new s.Range(0,0,0,1),{title:"ㅤ$(stop-circle)ㅤ",tooltip:"Stop",command:"quokka.stopCurrent"}))),e}lines(){return this._lines}render(){this._doRender()}refreshHeaderCommands(){this._refreshCodeLens()}_doRender(e){if(this.disposed||!this.channelEnabled)return;let t="";(e=e||0)||(t+=this._prefix);for(let i=e,s=this._lines.length;i<s;i++)if((t+=this._lines[i]+"\n").length>this._contentLimit){t+="\n--- output truncated to "+this._contentLimit+" bytes ---\n";break}if(e)this._channel.append(t.replace(/\u0000/g,""));else if(this._channel.replace&&this._replaceApiAvailable)try{this._channel.replace(t.replace(/\u0000/g,""))}catch(e){this._channel.clear(),this._channel.append(t.replace(/\u0000/g,"")),this._replaceApiAvailable=!1}else this._channel.clear(),this._channel.append(t.replace(/\u0000/g,""));this._refreshCodeLens()}_refreshCodeLens(e){this.isLiveShareClient||(this._activeCodeLens=[],!e&&this._lines.length&&this._getShowCodeLensInOutputChannelSetting()&&(this._activeCodeLens=this._headerCodeLens().concat(this._codeLens.slice())),this._onDidChangeCodeLenses.fire())}clear(){this._lines=[],this._links=[],this._codeLens=[],this._activeCodeLens=[],this._onDidChangeCodeLenses.fire()}clearAndRenderHeader(){this.clear(),this._appendLine("none",0,this._header),this._doRender()}appendConsoleMessage(e){const t=this._lines.length;this._outputMessage(e),this._doRender(t)}show(){this.disposed||this._channel.show(!0)}areDifferent(e,t){return e!==t}setHeaderData(e){if(this.disposed)return;let t=e.plugins||[];e.builtInPlugins&&t.push(...e.builtInPlugins),t.sort((e,t)=>e.localeCompare(t));try{this._header=this._markupStartToken("header")+"Quokka"+(this._isProVersion()?" PRO":"")+" '"+this._displayedFileName+"'"+` (node: ${e.nodeVersion}${e.ts?`, TypeScript: ${e.ts.version&&"v"+e.ts.version||"unknown version"}`:""}${e.babel?`, babel: ${e.babel.version&&"v"+e.babel.version||"unknown version"}`:""}${t.length?`, plugins: ${t.join(", ")}`:""})${this._markupStartToken("header")}`}catch(e){console.log(e)}}_markupStartToken(e){const t=this._markupTokens[e];return a.isObject(t)?t.start:t}_markupEndToken(e){const t=this._markupTokens[e];return a.isObject(t)?t.end:t}_markupAltEndToken(e){const t=this._markupTokens[e];return a.isObject(t)?t.altEnd||t.end:t}_outputMessage(e){if("diff"===e.type){if(!e.context&&!e.actual&&!e.expected)return;e.text=e.context,delete e.context}e.context&&e.context.replace&&(e.context=e.context.replace(/\r\n\s*/g," ").replace(/\n\s*/g," "));const t=e.text&&(e.text.length>20||~e.text.indexOf("\n"))&&"diff"!==e.type;let i="error"===e.type?"error":"warn"===e.type||"diff"===e.type?"context":"none";if(t)this._addRevealInValueExplorerLens(this._lines.length+1,e),this._appendLine("none"===i&&e.format?"string":i,0,this._messageSeparator+e.text),this._outputLink(e,1);else{"diff"===e.type&&this._outputDiff(0,e.expected,e.actual),e.format&&(i="string");let t=e.text?`${"diff"===e.type?a.pad("",2,"   "):this._messageSeparator}${this._markupStartToken(i)}${e.text}${this._markupAltEndToken(i)}`:"";if(e.file){"string"!==i&&(t+=" ");const s=this._markupStartToken("link")+e.file+this._displayLocation(e.loc)+this._markupEndToken("link");t+=this._buildStackEntryLineText(e.context)+s,this._addFileLink(e.file,e.loc,s,t.length-s.length,this._lines.length+(t.split(/\r\n|\r|\n/).length-1)),this._addRevealInValueExplorerLens(this._lines.length+1,e)}this._appendLine("none",0,t)}}_addRevealInValueExplorerLens(e,t){this._codeLens.push(new s.CodeLens(new s.Range(e,0,e,1),{title:"$(list-tree) Reveal in value explorer",tooltip:"Reveal in value explorer",command:"quokka.revealInValueExplorer",arguments:[t]}))}_outputCallStack(e){this._appendLine("none",0,""),this._codeLens.push(new s.CodeLens(new s.Range(this._lines.length,0,this._lines.length,1),{title:"$(eye-closed) Hide Call Stack",tooltip:"Hide Call Stack",command:"quokka.hideCallStack"}));for(let t of e){const e=this._buildStackEntryLineText(t.context),i=e+this._markupStartToken("link")+t.file+this._displayLocation(t.loc)+this._markupEndToken("link");this._appendLine("none",0,i);let a=this._lines.length-1;this._links.push({range:new s.Range(a,e.length,a,i.length),target:s.Uri.parse("command:quokka.openCallStackFrame?"+encodeURIComponent(JSON.stringify(t)))})}}_outputError({message:e,stack:t,expected:i,actual:s,missingPackage:o,missingBrowserGlobal:n}){let r=this;this._outputDiff(0,i,s),o&&!this.isLiveShareClient&&(this._addEmptyLine(),this._addCustomLinkLine(`Install "${o}" package for the current quokka file`,"command:quokka.installMissingPackageToQuokka",0),this._hasOpenedProject&&this._addCustomLinkLine(`Install "${o}" package into the project`,"command:quokka.installMissingPackageToProject",0)),n&&!this.isLiveShareClient&&(this._addEmptyLine(),this._appendLine("context",0,`"${n}" looks like a browser global`),this._addCustomLinkLine("Install and use quokka browser plugin",`command:quokka.installQuokkaPlugin?${encodeURIComponent(JSON.stringify(["jsdom","jsdom-quokka-plugin"]))}`,0),this._addCustomLinkLine("Open quokka browser plugin documentation","https://quokkajs.com/docs/configuration.html#jsdom",0)),this._appendLine("error",0,this._messageSeparator+e),a.each(t,e=>r._outputLink(e,1))}_outputDiff(e,t,i){if(this._dmp&&(t||i)){this._appendLine("none",0,"");let s=this._dmp.diff_prettyHtml(this._dmp.diff_wordMode(t||"",i||"")).replace(/&para;<br>/g,"\n").replace(/<br>/g,"\n").replace(/<\/?span[^>]*>/g,"").replace(/<ins[^>]*>/g,this._markupStartToken("tmpDiffIns")).replace(/<del[^>]*>/g,this._markupStartToken("tmpDiffDel")).replace(/<\/ins[^>]*>/g,this._markupEndToken("tmpDiffIns")).replace(/<\/del[^>]*>/g,this._markupEndToken("tmpDiffDel")).replace(/style="background:#e6ffe6;"/g,"").replace(/style="background:#ffe6e6;"/g,"").replace(/&lt;/g,"<").replace(/&amp;/g,"&").replace(/&gt;/g,">"),a=0,o=0;this._appendLine("diff",e,s,void 0,void 0,e=>{if(!e)return e;a>0&&(e=this._markupStartToken("diffIns")+e),o>0&&(e=this._markupStartToken("diffDel")+e);let t=(e.match(new RegExp(this._markupStartToken("tmpDiffIns"),"g"))||[]).length,i=(e.match(new RegExp(this._markupEndToken("tmpDiffIns"),"g"))||[]).length;a+=t-i;let s=(e.match(new RegExp(this._markupStartToken("tmpDiffDel"),"g"))||[]).length,n=(e.match(new RegExp(this._markupEndToken("tmpDiffDel"),"g"))||[]).length;return o+=s-n,a>0&&(e+=this._markupEndToken("diffIns")),o>0&&(e+=this._markupEndToken("diffDel")),e.replace(new RegExp(this._markupStartToken("tmpDiffIns"),"g"),this._markupStartToken("diffIns")).replace(new RegExp(this._markupEndToken("tmpDiffIns"),"g"),this._markupEndToken("diffIns")).replace(new RegExp(this._markupStartToken("tmpDiffDel"),"g"),this._markupStartToken("diffDel")).replace(new RegExp(this._markupEndToken("tmpDiffDel"),"g"),this._markupEndToken("diffDel"))})}}_outputLink(e,t){if(e.file){const i=e.file+this._displayLocation(e.loc);this._appendLine("link",t,i,void 0,e.context,(t,s)=>{this._addFileLink(e.file,e.loc,i,s)})}}_addCustomLinkLine(e,t,i){let a=this._lines.length;this._appendLine("none",i,this._markupStartToken("link")+e+this._markupEndToken("link")),this._links.push({range:new s.Range(a,this._markupStartToken("link").length,a,e.length+this._markupEndToken("link").length),target:s.Uri.parse(t)})}_addFileLink(e,t,i,a,o){"."!==e[0]&&e!==this._quokkaFileName||(o=o||this._lines.length,this._links.push({range:new s.Range(o,a,o,a+i.length),target:0===e.indexOf("quokka")?s.Uri.parse("command:quokka.goToLineInQuokkaFile?"+JSON.stringify(this._location(t).substring(1))):s.Uri.parse(s.Uri.file(this._absolutePathResolver(e)).toString()+this._location(t,0))}))}_location(e){let[t,i]=this._locationArray(e);return"#"+(a.isNumber(i)?`${t},${i}`:t)}_locationArray(e){let t,i;return a.isNumber(e)?t=e:a.isArray(e)?(t=e[0],i=e[1]):a.isString(e)&&(t=(e=e.split(":"))[0]&&parseInt(e[0],10),i=e[1]&&parseInt(e[1],10)),a.isNumber(i)&&i<0&&(i=0),[t,i]}_displayLocation(e){if(!e)return"";let[t,i]=this._locationArray(e);return`:${t}${a.isNumber(i)?":"+(i+1):""}`}_addEmptyLine(){this._appendLine("none",0,"")}_appendLine(e,t,i,s,o,n){let r=this,l=i.split("\n"),c=[this._markupStartToken(e)||"",this._markupEndToken(e)||""];a.each(l,(i,h)=>{const d=(s?`[${s}] `:"")+a.pad("",2*t,"   ")+("link"===e?this._buildStackEntryLineText(o):"")+("diff"===e?0===h?c[0]:"":c[0]);let u=d+i+("diff"===e?"":c[1]);if(n){let e=n(u,d.length);e&&(u=e)}"diff"===e&&(u+=h===l.length-1?c[1]:""),r._lines.push(u)})}_buildStackEntryLineText(e){return this._markupStartToken("empty")+"at "+this._markupEndToken("empty")+(e?this._markupStartToken("context")+e+this._markupEndToken("context")+" ":"")}}},{vscode:void 0}],10:[function(e,t,i){"use strict";const s=e("vscode"),a=e("path"),o=e("util"),n=e("fs"),r=e("os"),l=o.promisify(n.readFile),c=o.promisify(n.writeFile),h=e=>l(e).then(e=>e.toString()),d=e=>h(e).catch(()=>""),u=e("./compositeDisposable"),_="quokka-recent",p=s.Uri.parse("quokka-recent:Recent Quokka Files");class g{constructor(e){this._disposables=new u,this._onDidChange=new s.EventEmitter,this._quokkaFolder=e,this._quokkaRecentFilesMetadataPath=a.join(e,"recentFiles.json"),this._quokkaRecentFilesFolderPath=a.join(e,"recentFiles"),this._disposables.add(s.languages.registerCodeLensProvider([_],this)),this._disposables.add(s.workspace.registerTextDocumentContentProvider(_,this)),this.reset()}async findRecentScratchFileIdByContent(e){if(!e)return;e=e.trim();const t=await this._getMetadata();if(!t||!t.projects)return;const i=Object.keys(t.projects);let s=0;for(;i.length;){const a=t.projects[i.pop()];if(a){const t=Object.values(a);for(let i of t)if(i.scratchFile){if((i.content&&i.content.trim())===e)return i.fileId;if(++s>=5)return}}}}reset(){delete this._metadata}dispose(){this._disposed||(this._disposables.dispose(),this._disposed=!0)}async show(e){if(this.reset(),this._content=await this._buildContent(e||this._quokkaFolder),!this._content)return;this._onDidChange.fire(p);const t=await s.window.showTextDocument(p);t.options.lineNumbers=s.TextEditorLineNumbersStyle.Off,s.languages.setTextDocumentLanguage(t.document,_)}get onDidChange(){return this._onDidChange.event}static prepareContentText(e){return e.replace(/ /g," ")}static formatProjectDir(e){return e.replace(r.homedir(),"~")}static pathToMetadataKey(e){return e&&"win32"===process.platform?e.toLowerCase():e}async removeRecentFiles(e){let t;try{t=JSON.parse(await h(this._quokkaRecentFilesMetadataPath))}catch(e){}if(!t||!t.projects)return;const i=Object.keys(t.projects);for(;i.length;){const s=i.pop(),a=t.projects[s];if(a)for(let t of e)g.pathToMetadataKey(t.projectRoot)===s&&delete a[t.id]}try{await c(this._quokkaRecentFilesMetadataPath,JSON.stringify(t))}catch(e){}}async _buildContent(e){const t=await this._getMetadata();if(!t||!t.projects)return;this._lenses=[];const i=g.pathToMetadataKey(e);let o=[];const n=e=>{const t=`${e.modificationDate.toLocaleDateString()} ${e.modificationDate.toLocaleTimeString()}`;let a,n;i===e.projectRootKey||g.pathToMetadataKey(this._quokkaFolder)===e.projectRootKey?a=e.path:(a=e.resolvedPath,n=!0),o.push({text:`⁠${g.formatProjectDir(a)}⁠  ${t} `});const r=(()=>o.length-1)();if(this._lenses.push(new s.CodeLens(new s.Range(r,0,r,0),{title:"Run",tooltip:"Run",command:"quokka.runRecentFile",arguments:[e]})),e.scratchFile&&this._lenses.push(new s.CodeLens(new s.Range(r,0,r,0),{title:"Clone and Run",tooltip:"Clone and Run",command:"quokka.runRecentFile",arguments:[{clone:!0,...e}]})),n){const t=g.formatProjectDir(e.projectRoot);this._lenses.push(new s.CodeLens(new s.Range(r,0,r,0),{title:"Run in "+t,tooltip:"Run in "+t,command:"quokka.runRecentFile",arguments:[{runInParentProject:!0,...e}]})),e.scratchFile&&this._lenses.push(new s.CodeLens(new s.Range(r,0,r,0),{title:"Clone and Run in "+t,tooltip:"Clone and Run in "+t,command:"quokka.runRecentFile",arguments:[{clone:!0,runInParentProject:!0,...e}]}))}this._lenses.push(new s.CodeLens(new s.Range(r,0,r,0),{title:"Remove from recent files",tooltip:"Remove from recent files",command:"quokka.removeRecentFiles",arguments:[{files:[e],reloadRecentFilesView:!0}]})),o.push({text:"​"})},r=t.projects[i];r&&(delete t.projects[i],t.projects[i]=r);const l=Object.keys(t.projects),c=[];for(;l.length;){const e=l.pop(),i=t.projects[e];if(i){const t=Object.values(i).reverse();for(let i of t){i.scratchFile&&(i.path=i.path.replace("quokka","scratch")),i.projectRootKey=e,i.resolvedPath=a.resolve(i.projectRoot,i.path),i.id=i.fileId||g.pathToMetadataKey(i.path);const t=i.content||await d(i.scratchFile?a.join(this._quokkaRecentFilesFolderPath,i.fileId):i.resolvedPath);if(!t){c.push(i);continue}i.content=t.trim(),i.modificationDate=new Date(i.ts),n(i);const s=i.content.split(/\r\n|\r|\n/).map(e=>({text:`  ${e}`}));(o=o.concat(s)).push({text:"​"})}}}return c.length&&s.commands.executeCommand("quokka.removeRecentFile",{files:c}),{lines:o,text:o.map(e=>e.text).join("\n"),annotationDecorations:[]}}provideTextDocumentContent(){return this._content&&this._content.text||""}provideCodeLenses(e){return this._lenses||[]}async _getMetadata(){if(this._metadata)return this._metadata;try{this._metadata=JSON.parse(await h(this._quokkaRecentFilesMetadataPath))}catch(e){this._metadata={projects:{}}}return this._metadata}}t.exports=g},{"./compositeDisposable":6,fs:void 0,os:void 0,path:void 0,util:void 0,vscode:void 0}],11:[function(e,t,i){"use strict";const s=e("vscode"),a=e("util"),o=e("path"),n=e("fs"),r=e("os"),l=e("./licenseReader").LicenseReader;class c{constructor(e,t){this._disposables=[],this._checkOffersResults=void 0,this._panel=e,this._context=t,this._extensionUri=t.extensionUri,this._pendingMessages=[],this._initialized=!1,this._panel.iconPath=s.Uri.file(t.asAbsolutePath("media/logo.svg")),this._load()}static setController(e){c.controller=e}static async getStartViewWhatsNewVersion(e){const t=s.Uri.joinPath(e.extensionUri,"media","index.html"),i=[...new a.TextDecoder("utf8").decode(await s.workspace.fs.readFile(t)).matchAll(/data-whats-new-version=["|']([a-zA-Z0-9\-\!\,]+)["|']/gm)],o=e.globalState.get("quokka.country","US");return Math.max(...i.map(e=>{const[,t]=e,[i,s]=t.split("-");return{version:parseInt(i,10),country:s||o}}).filter(e=>e.country===o).map(e=>e.version))}static async showWhatsNewIfRequired(e){if(!s.workspace.getConfiguration().get("quokka.showStartViewOnFeatureRelease",!0))return!1;try{if(await c.getStartViewWhatsNewVersion(e)>c._getUserWhatsNewVersion())return c.createOrShow(e,{type:"whatsnew"}),!0}catch(e){console.log(e)}return!1}static createOrShow(e,t){const i=s.window.activeTextEditor?s.window.activeTextEditor.viewColumn:void 0;if(c.currentPanel)return c.currentPanel._panel.reveal(i),void c.currentPanel._processAction(e,t);const a=s.window.createWebviewPanel(c.viewType,"Quokka",i||s.ViewColumn.One,{enableScripts:!0,localResourceRoots:[s.Uri.joinPath(e.extensionUri)]});c.currentPanel=new c(a,e),c.currentPanel._processAction(e,t)}async _processAction(e,t){if(t)switch(t.type){case"activate":c.currentPanel.activateLicense(t);break;case"trial":c.currentPanel.requestTrial(t);break;case"goToLicenseSection":c.currentPanel.goToLicenseSection(t);break;case"showAllWhatsNew":c.currentPanel.showWhatsNew(!0),c.currentPanel._panel.title="Quokka: What's New";break;case"whatsnew":c.currentPanel.showWhatsNew(!1),c.currentPanel._panel.title="Quokka: What's New";break;case"firstInstall":const i=await c.getStartViewWhatsNewVersion(e);c.controller&&c.controller._salesEvent&&c.controller._salesEvent.setLastUrlOpenedTime(),c._saveUserWhatsNewVersion(i),c.currentPanel.firstInstall(t)}}static revive(e,t){c.currentPanel&&c.currentPanel.dispose(),c.currentPanel=new c(e,t)}activateLicense(){this._pendingMessages.push({command:"activateLicense"}),this.processPendingMessages()}firstInstall(e){this._pendingMessages.push({command:"firstInstall",...e}),this.processPendingMessages()}goToLicenseSection(){this._pendingMessages.push({command:"goToLicenseSection"}),this.processPendingMessages()}requestTrial(){this._pendingMessages.push({command:"requestTrial"}),this.processPendingMessages()}showWhatsNew(e){const t=e?0:c._getUserWhatsNewVersion();this._pendingMessages.push({command:"showWhatsNew",previousWhatsNewVersion:t}),this.processPendingMessages()}processPendingMessages(){if(this._initialized){const e=this._pendingMessages;this._pendingMessages=[],e.forEach(e=>{this._panel.webview.postMessage(e)})}}_getGlobalConfigSettings(){try{return{...c.globalDefaults,...JSON.parse(n.readFileSync(c.quokkaConfigPath))}}catch(e){return{...c.globalDefaults}}}_saveGlobalConfigSettings(e){e={...e},Object.keys(c.globalDefaults).forEach(t=>{e[t]===c.globalDefaults[t]&&delete e[t]}),n.writeFileSync(c.quokkaConfigPath,JSON.stringify(e)),this._panel.webview.postMessage({command:"globalConfig",globalConfig:this._getGlobalConfigSettings()})}_load(){this._update().then(()=>{this._panel.onDidDispose(()=>this.dispose(),null,this._disposables),this._panel.onDidChangeViewState(()=>{this._panel.visible?this._update():this._initialized=!1},null,this._disposables);const e=e=>{const t=s.workspace.getConfiguration().inspect(e);return void 0!==t.globalValue?t.globalValue:t.defaultValue};this._panel.webview.onDidReceiveMessage(t=>{switch(t.command){case"requestInitialState":const i=e("quokka.compactMessageOutput"),a=e("quokka.showOutputOnStart"),o=e("quokka.startViewStatusBar"),r=e("quokka.suppressExpirationNotifications"),l=e("quokka.showStartViewOnFeatureRelease"),h=e("quokka.automaticRestart"),d=e("quokka.automaticStartRegex"),u=this._context.globalState.get("quokka.country","US"),_=c.controller&&c.controller._buildDate||new Date;return _.setHours(0,0,0),this._panel.webview.postMessage({command:"initialState",settings:{compactMessageOutput:i,showOutputOnStart:a,startViewStatusBar:o,suppressExpirationNotifications:r,showStartViewOnFeatureRelease:l,automaticRestart:h,automaticStartRegex:d},globalConfig:this._getGlobalConfigSettings(),licenseDetails:c.getLicenseDetails(),whatsNewVersion:c._getUserWhatsNewVersion(),buildDate:_,country:u}),this._initialized=!0,void this.processPendingMessages();case"saveGlobalConfig":this._saveGlobalConfigSettings(t.globalConfig);break;case"updateSetting":s.workspace.getConfiguration().update("quokka."+t.setting,t.value,s.ConfigurationTarget.Global);break;case"otherSettings":s.commands.executeCommand("workbench.action.openSettings","quokka");break;case"configJson":n.existsSync(c.quokkaConfigPath)||n.writeFileSync(c.quokkaConfigPath,JSON.stringify({})),s.workspace.openTextDocument(c.quokkaConfigPath).then(e=>s.window.showTextDocument(e));break;case"useCommunityEdition":this._useCommunityEdition();break;case"switchToPro":this._usePro();break;case"launchDemo":this._launchDemo();case"trialRequest":this._requestTrialLicense(t.email);break;case"activateLicense":this._activateLicense(t);break;case"updateWhatsNewVersion":c._saveUserWhatsNewVersion(t.version);break;case"log":console.log(t)}},null,this._disposables)})}async _launchDemo(){if(c.controller){const e=s.Uri.joinPath(this._extensionUri,"media","interactive-demo.js");let t=new a.TextDecoder("utf8").decode(await s.workspace.fs.readFile(e));"darwin"===process.platform&&(t=t.replace(/`Ctrl/gm,"`⌘")),c.controller._createLanguageFile("JavaScript",t)}}_useCommunityEdition(){try{let e;try{e=JSON.parse(n.readFileSync(c.quokkaConfigPath))}catch(t){e={}}e.pro=!1,n.writeFileSync(c.quokkaConfigPath,JSON.stringify(e))}catch(e){}this._panel.webview.postMessage({command:"switchToCommunityEdition",licenseDetails:c.getLicenseDetails()})}_usePro(){try{let e;try{e=JSON.parse(n.readFileSync(c.quokkaConfigPath))}catch(t){e={}}e.pro=!0,n.writeFileSync(c.quokkaConfigPath,JSON.stringify(e))}catch(e){}this._panel.webview.postMessage({command:"switchToPro",licenseDetails:c.getLicenseDetails()})}_activateLicense({email:e,key:t}){if(!c.controller)return void this._panel.webview.postMessage({command:"activationError",message:"VS Code has not finished loading, please try and activate again later."});const i=new Date;let s=!1;c.controller.processLicenseChange(e||t,e=>{if(!s){s=!0;const t=new Date-i,a=e=>t<500?setTimeout(e,500-t):e();"notification"===e.type&&(e=e.text),"info"===e.type||"warning"===e.type?a(()=>this._panel.webview.postMessage({command:"activationSuccess",message:e.text,licenseDetails:c.getLicenseDetails()})):a(()=>this._panel.webview.postMessage({command:"activationError",message:e.text}))}}),e&&setTimeout(()=>{s||(s=!0,this._panel.webview.postMessage({command:"activationError",message:"A timeout occurred while attempting to validate your email address."}))},25e3)}_requestTrialLicense(t){const i=e("https"),s=JSON.stringify({email:t,type:"quokka",referrer:"qsp"}),a={hostname:"x55r2pae4l.execute-api.us-east-1.amazonaws.com",port:443,path:"/Prod/bc88894221b34ae4adac5c39a51547a2",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(s)}},o=i.request(a,e=>{200===e.statusCode?this._panel.webview.postMessage({command:"trialRequestSuccess"}):this._panel.webview.postMessage({command:"trialRequestError"})});o.on("error",e=>{this._panel.webview.postMessage({command:"trialRequestError"}),console.error(e)}),o.write(s),o.end()}static _checkForOffers(t){if(c.controller&&c.controller._salesEvent&&c.controller._salesEvent.saleInProgress())return void t({displayDiscount:!1,sale:!0,saleDiscount:c.controller._salesEvent.discountAmount()});if(void 0!==c._checkOffersResults)return void(c._checkOffersResults.discount&&c._checkOffersResults.discount>5?t(c._checkOffersResults):t({displayDiscount:!1}));let i=!1;e("./checkOffers").checkForOffers(e=>{i||(i=!0,e.offer_price&&e.list_price?(e.discount=Math.floor(100-100*e.offer_price/e.list_price),e.displayDiscount=e.discount>5,e.displayDiscount||(e.discount=0),c.controller&&c.controller._salesEvent&&c.controller._salesEvent.saleInProgress()&&(e.sale=!0,e.saleDiscount=c.controller._salesEvent.discountAmount()),c._checkOffersResults=e,t(e)):t({displayDiscount:!1}))}),setTimeout(()=>{i||(i=!0,c._checkOffersResults={},t({displayDiscount:!1}))},15e3)}static _getUserWhatsNewVersion(){try{return JSON.parse(Buffer.from(n.readFileSync(c.startPage).toString())).version}catch(e){return 0}}static _saveUserWhatsNewVersion(e){try{n.writeFileSync(c.startPage,JSON.stringify({version:e}))}catch(e){console.error(e)}}static getLicenseDetails(){const e=c.controller&&c.controller._buildDate||new Date,t=l.getLicenseDetails(e);var i;return"community"===t.state&&c._checkForOffers(e=>{e&&c.currentPanel&&c.currentPanel._panel&&c.currentPanel._panel.webview.postMessage({command:"countryDiscount",offer:{discount:e.discount,country:(i=e.country,{AF:"Afghanistan",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AG:"Antigua and Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia and Herzegovina",BW:"Botswana",BV:"Bouvet Island",BR:"Brazil",IO:"Brit. Indian Ocean",VG:"British Virgin Islands",BN:"Brunei Darussalam",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CX:"Christmas Island",CC:"Cocos Islands",CO:"Colombia",KM:"Comoros",CG:"Congo",CK:"Cook Islands",CR:"Costa Rica",CI:"Cote D’Ivoire",HR:"Croatia",CU:"Cuba",CW:"Curaçao",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",TF:"French Southern Terr.",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GH:"Ghana",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GU:"Guam",GT:"Guatemala",GG:"Guernsey",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HM:"Heard/ Mcdonald Islands",VA:"Holy See/ Vatican City",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran",IQ:"Iraq",IE:"Ireland",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JE:"Jersey",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KW:"Kuwait",KG:"Kyrgyzstan",LA:"Lao People’s DR",LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libyan Arab Jamahiriya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macao",MK:"Macedonia",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",KP:"North Korea",MP:"Northern Mariana Islands",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PS:"Palestinian Territory",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RS:"Republic of Serbia",RE:"Reunion",RO:"Romania",RU:"Russian Federation",RW:"Rwanda",GS:"S. Georgia/ Sandwich Islands",SH:"Saint Helena",KN:"Saint Kitts and Nevis",LC:"Saint Lucia",PM:"Saint Pierre and Miquelon",VC:"Saint Vincent/ Grenadines",WS:"Samoa",SM:"San Marino",ST:"Sao Tome and Principe",SA:"Saudi Arabia",SN:"Senegal",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",KR:"South Korea",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SJ:"Svalbard and Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syrian Arab Republic",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",TL:"Timor-Leste",TG:"Togo",TK:"Tokelau",TO:"Tonga",TT:"Trinidad and Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks and Caicos Islands",TV:"Tuvalu",VI:"U.S. Virgin Islands",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UM:"United States (M.O.I.)",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VE:"Venezuela",VN:"Vietnam",WF:"Wallis and Futuna",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"}[i]),display:e.displayDiscount,sale:!!e.sale,saleDiscount:e.saleDiscount}})}),t}dispose(){for(c.currentPanel=void 0,this._panel.dispose(),this._panel=void 0;this._disposables.length;){const e=this._disposables.pop();e&&e.dispose()}}async _update(){const e=this._panel.webview;this._panel.webview.html=await this._getHtmlForWebview(e)}async _getHtmlForWebview(e){const t=s.Uri.joinPath(this._extensionUri,"media","index.html"),i=new a.TextDecoder("utf8").decode(await s.workspace.fs.readFile(t)),o={nonce:function(){let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let i=0;i<32;i++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}(),cspSource:e.cspSource,root:e.asWebviewUri(this._extensionUri).toString()};return Object.keys(o).reduce((e,t)=>e.replace(new RegExp(("${"+t+"}").replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),"g"),o[t]),i)}}c.quokkaFolder=o.join(r.homedir(),".quokka"),c.wallabyFolder=o.join(r.homedir(),".wallaby"),c.lkp=o.join(c.quokkaFolder,".qlc"),c.quokkaConfigPath=o.join(c.quokkaFolder,"config.json"),c.olp=o.join(c.wallabyFolder,".ol"),c.startPage=o.join(c.quokkaFolder,"startPage.json"),c.globalDefaults={autoLog:!1,showValueOnSelection:!0,showSingleInlineValue:!0,delay:0,logLimit:100,recycle:!1},c.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],c.viewType="quokkaStartPage",t.exports=c},{"./checkOffers":5,"./licenseReader":8,fs:void 0,https:void 0,os:void 0,path:void 0,util:void 0,vscode:void 0}],12:[function(e,t,i){"use strict";const s=e("vscode"),a=global._,o=s.window,n=e("./compositeDisposable");let r;class l{constructor(e,t){this._ts=+new Date,this._disposables=new n,this._quokkaFileUri=e,this._quokkaFileName=t,this._opacityMultiplier=s.workspace.getConfiguration().get("quokka.dimmedTextOpacity",50),this._onDidChange=new s.EventEmitter,this._onDidChangeCodeLenses=new s.EventEmitter;const i=new s.ThemeColor("editorCodeLens.foreground");this._annotationDecorationType=s.window.createTextEditorDecorationType({rangeBehavior:s.DecorationRangeBehavior.ClosedOpen,textDecoration:"none",before:{height:"100%",margin:"0 26px 0 0"}}),this._subtleDecorationType=s.window.createTextEditorDecorationType({rangeBehavior:s.DecorationRangeBehavior.ClosedOpen,textDecoration:"none",opacity:this._getOpacity(.3)}),this._logDecorationType=s.window.createTextEditorDecorationType({isWholeLine:!0,light:{after:{color:"#0000ff"}},dark:{after:{color:"rgba(86, 156, 214, 1)"}}}),this._systemLogDecorationType=s.window.createTextEditorDecorationType({isWholeLine:!0,after:{color:i}}),this._errorDecorationType=s.window.createTextEditorDecorationType({isWholeLine:!0,light:{after:{color:"#c80000"}},dark:{after:{color:"#fe536a"}}}),this._lineNumberStyle={color:i,opacity:this._getOpacity(.6)},this._fileContentSeparatorStyle={color:i,opacity:this._getOpacity(.5)},this._content={},this._disposables.add(()=>{this._annotationDecorationType.dispose(),this._subtleDecorationType.dispose(),this._logDecorationType.dispose(),this._systemLogDecorationType.dispose(),this._errorDecorationType.dispose()})}_getOpacity(e){if(50===this._opacityMultiplier)return e.toFixed(2);if(this._opacityMultiplier<50)return Math.max(0,e-e*(50-this._opacityMultiplier)/50).toFixed(2);{const t=1-e;return Math.min(1,e+t*(this._opacityMultiplier-50)/50).toFixed(2)}}get onDidChange(){return this._onDidChange.event}get onDidChangeCodeLenses(){return this._onDidChangeCodeLenses.event}_initialize(){this._initialized||(this._definitionProvider=s.languages.registerDefinitionProvider({scheme:"quokka-code-timeline",language:"quokka-timeline"},this),this._codeLensProvider||(this._codeLensProvider=s.languages.registerCodeLensProvider({scheme:"quokka-code-timeline",language:"quokka-timeline"},this)),this._changeRevealIfOpenSetting(),this._initialized=!0)}clear(e){this._initialized&&(this._definitionProvider.dispose(),delete this._content,delete this._expectingTimelineLoad,e.forEach(e=>this._resetAllDecorations(e)),this._uri&&this._onDidChange.fire(this._uri),this._restoreRevealIfOpenSetting(),delete this._uri,delete this._initialized)}uri(){return this._uri}dispose(){this.clear([]),this._codeLensProvider&&(this._codeLensProvider.dispose(),delete this._codeLensProvider)}expectingTimelineLoad(){this._expectingTimelineLoad=!0}isExpectingTimelineLoad(){return this._expectingTimelineLoad}provideTextDocumentContent(){return this._providedTextDocumentContent=r===this._uri?(this._content||{}).text||"":null,this._providedTextDocumentContent}provideDefinition(e,t){if(!this._content||this._updating)return;const i=this._content.lines[t.line];return i&&i.file&&i.num?new s.Location(this._quokkaFileUri,new s.Position(i.num-1,t.character)):void 0}provideCodeLenses(e){if(this._initialized&&(this._onCodeLensProvided&&(this._onCodeLensProvided(),delete this._onCodeLensProvided),this._content&&this._content.codeLens&&!this._updating))return this._content.codeLens}static prepareContentText(e){return e.replace(/ /g," ")}getLineByStep(e){if(this._content)return this._content.lineByStep[e]}getOriginalLocationByLine(e){if(!this._content)return;const t=this._content.lines[e-1];if(!t||!t.file||!t.num)return;let i=t.step;if(!(i>=0))for(let t=e;t<this._content.lines.length&&!((i=this._content.lines[t].step)>=0);t++);return{file:t.file,line:t.num,step:i}}_changeRevealIfOpenSetting(){try{const e=s.workspace.getConfiguration();this._revealIfOpenSetting=(e.inspect("workbench.editor.revealIfOpen")||{}).globalValue,e.update("workbench.editor.revealIfOpen",!0,!0)}catch(e){}}_restoreRevealIfOpenSetting(){try{s.workspace.getConfiguration().update("workbench.editor.revealIfOpen",this._revealIfOpenSetting,!0),delete this._revealIfOpenSetting}catch(e){}}closing(){this._closing=new Promise(e=>{this._closed=e})}isClosing(){return!!this._closing}closed(){this._closed(),delete this._closing,delete this._closed}isActive(){return!this.isClosing()&&this._initialized}async show(e,t){try{if(!e)return;this._closing&&(t.length=0,await this._closing);const i=!!t.length;if(this._content=this._generateDecoratedContent(e),this._initialize(),r=this._uri=s.Uri.parse(`quokka-code-timeline://authority/${this._ts}/Quokka Code Story`),!t.length){await this._updateTimelineDocument();const e={preview:!1,viewColumn:-2,preserveFocus:!0},i=await s.window.showTextDocument(this._uri,e);i.options.lineNumbers=s.TextEditorLineNumbersStyle.Off,s.languages.setTextDocumentLanguage(i.document,"quokka-timeline"),t=[i]}await Promise.all(t.map(e=>this._updateEditor(e,i)))}finally{delete this._expectingTimelineLoad}}async _updateTimelineDocument(){void 0!==this._providedTextDocumentContent&&this._content.text!==this._providedTextDocumentContent&&await new Promise(e=>{const t=s.workspace.onDidChangeTextDocument(s=>{s.document&&s.document.uri&&"quokka-code-timeline"===s.document.uri.scheme&&(clearTimeout(i),t.dispose(),e())}),i=setTimeout(()=>{t.dispose(),e()},2e3);this._onDidChange.fire(this._uri)})}async _updateEditor(e,t){if(this._updating=!0,t){const e=new Promise(e=>{const t=setTimeout(()=>{e()},500);this._onCodeLensProvided=(()=>{clearTimeout(t),setImmediate(e)})});this._onDidChangeCodeLenses.fire(),await e}await this._updateTimelineDocument(),delete this._updating,this._onDidChangeCodeLenses.fire(),this._resetAllDecorations(e),this._updateDecorations(e)}update(e){e.options.lineNumbers=s.TextEditorLineNumbersStyle.Off,this._updateDecorations(e)}isTimelineLoaded(){return!!this._content}_updateDecorations(e){if(!e)return;if(!e.document||!e.document.uri||"quokka-code-timeline"!==e.document.uri.scheme)return;const t=this._content;t?(e.setDecorations(this._annotationDecorationType,t.annotationDecorations),e.setDecorations(this._subtleDecorationType,t.subtleDecorations),e.setDecorations(this._errorDecorationType,t.errorDecorations)):this._resetAllDecorations(e)}_resetAllDecorations(e){e.setDecorations(this._logDecorationType,[]),e.setDecorations(this._systemLogDecorationType,[]),e.setDecorations(this._errorDecorationType,[]),e.setDecorations(this._annotationDecorationType,[]),e.setDecorations(this._subtleDecorationType,[])}updateTimelineEditorInlineValueDecorations(e,t,i){if(!e||!t)return;if(!e.document||!e.document.uri||"quokka-code-timeline"!==e.document.uri.scheme)return;const a=this.getOriginalLocationByLine(t);if(!a)return;const o=i[a.file];if(!o||!o.lines||!o.lines.length)return;const n=o.lines.find(e=>e.num===a.line);if(!n)return;const r=e.document.lineAt(t-1);if(!r)return;const l={range:new s.Range(r.lineNumber,r.firstNonWhitespaceCharacterIndex,r.lineNumber,r.range.end.character)},c=n.log||"",h=n.longLog||c;h&&(l.hoverMessage=s.MarkdownString?new s.MarkdownString("```js\n"+h+"\n```"):h),l.renderOptions={after:{contentText:" ".repeat(2)+c}};const d=n.meta&&n.meta.system?this._systemLogDecorationType:this._logDecorationType;e.setDecorations(this._logDecorationType,[]),e.setDecorations(this._systemLogDecorationType,[]),c&&e.setDecorations(d,[l])}_generateDecoratedContent(e){const t=[],i=[],a=[],o=[];let n,r,c,h;const d=[],u={},_=()=>d.length-1,p=e.maxLineNumber.toString().length,g=e=>{const i=_();t.push({range:new s.Range(i,0,i,1),renderOptions:{before:{contentText:l.prepareContentText((e=>`${" ".repeat(p-e.toString().length)}${e}`)(e)),...this._lineNumberStyle}}})},m=()=>{const e=_();t.push({range:new s.Range(e,0,e,1),renderOptions:{after:{contentText:l.prepareContentText("…"),...this._fileContentSeparatorStyle}}})},v=(e,t,o)=>{for(const l of t){const t=l.n||"",c=l.content?`${l.content}`:l.separator?"​​":" ",h={text:c,num:t,file:e};d.push(h),l.separator&&m();const p=_();if(l.executedLine){l.steps=l.steps||[o];for(const e of l.steps)u[e]=p;if(l.error){const e={range:new s.Range(p,0,p,c.length)},t=l.error;e.renderOptions={after:{contentText:" ".repeat(2)+t}},a.push(e)}h.step=l.steps[0],void 0===n&&(n=h.step),r=l.steps[l.steps.length-1]}if((!l.executedLine||l.contextRanges)&&!l.separator)if(l.contextRanges)for(const[e,t]of l.contextRanges)i.push({range:new s.Range(p,e,p,t)});else i.push({range:new s.Range(p,0,p,c.length)});g(t)}};e.truncatedStart&&(d.unshift({text:"​"}),c=new s.CodeLens(new s.Range(1,0,1,1),{title:"Load previous entries",command:"quokka.viewCodeStory"}),d.push({text:"​"}));for(const t of e.entries)t.file&&(t.file,d.push({text:"​"}),t.hideable&&o.push(new s.CodeLens(new s.Range(d.length-2,0,d.length-2,1),{title:"Hide repeated entries like this",command:"quokka.viewCodeStory",arguments:[{hide:t}]}))),v(t.file,t.lines,t.step),d.push({text:"​"});return e.truncatedEnd&&(d.push({text:" "}),d.push({text:" "}),h=new s.CodeLens(new s.Range(d.length-1,0,d.length-1,1),{title:"Load next entries",command:"quokka.viewCodeStory"})),c&&(c.command.arguments=[{before:n}],o.push(c)),h&&(h.command.arguments=[{after:r}],o.push(h)),{lines:d,lineByStep:u,text:d.map(e=>e.text).join("\n"),annotationDecorations:t,subtleDecorations:i,errorDecorations:a,codeLens:o}}}class c{constructor(e,t,i){this._traceContext={},this._onUpdate=[],this._extensionContext=e,this._session=i,this.id=i.id}asAbsolutePath(e){return this._extensionContext.asAbsolutePath(e)}scheduleOnUpdate(e){this._onUpdate.push(e)}runPendingUpdates(){a.each(this._onUpdate,e=>{try{return e()}catch(e){}}),this._onUpdate.length=0}requestTrace(e){return new Promise(t=>this._session.requestTrace(e,e=>t(e)))}updateTraceContextCurrentFrame(e,t=!0){this._session.isDisposed()||this._session.traceContext({currentFrame:e,captureCallStackFrame:t?this._traceContext.frame:void 0})}requestCallStack(){this._session.isDisposed()||(this._session.traceContext({captureCallStackFrame:this._traceContext.frame}),this._session.runTests({file:this._session.fileName,evaluateExpression:!0}))}stopTraceNavigation(){this._session.isDisposed()||(this._session.output.refreshHeaderCommands(),this._session.traceContext({stopNavigation:!0}))}traceNavigationStarted(){this._session.output.refreshHeaderCommands()}requestTestTimeline(e,t){return this._session.requestTestTimeline(e,t)}}t.exports=class{constructor(e,t,i){this._disposables=new n,this._activeTraceFrameWithNowhereToGoDecorationType=o.createTextEditorDecorationType({rangeBehavior:1,borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",dark:{backgroundColor:"rgba(255, 0, 0, 0.2)",borderColor:"rgba(255, 0, 0, 0.2)"},light:{backgroundColor:"rgba(255, 0, 52, 0.35)",borderColor:"rgba(255, 0, 52, 0.35)"}}),this._activeTraceFrameDecorationType=o.createTextEditorDecorationType({rangeBehavior:1,borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",dark:{backgroundColor:"rgba(255, 255, 0, 0.2)",borderColor:"rgba(255, 255, 0, 0.2)"},light:{backgroundColor:"rgba(255, 255, 102, 0.45)",borderColor:"rgba(255, 255, 102, 0.45)"}}),this._activeTraceCallStackFrameDecorationType=o.createTextEditorDecorationType({rangeBehavior:1,borderStyle:"solid",borderRadius:"2px",borderWidth:"1px",dark:{backgroundColor:"rgba(122, 189, 122, 0.3)",borderColor:"rgba(122, 189, 122, 0.3)"},light:{backgroundColor:"rgba(206, 231, 206, 0.45)",borderColor:"rgba(206, 231, 206, 0.45)"}}),this._codeStoryContentProvider=new l(i.textDocument.uri,i.fileName),this._disposables.add(s.workspace.registerTextDocumentContentProvider("quokka-code-timeline",this._codeStoryContentProvider)),this._disposables.add(()=>{this._activeTraceFrameWithNowhereToGoDecorationType.dispose(),this._activeTraceFrameDecorationType.dispose(),this._activeTraceCallStackFrameDecorationType.dispose(),this._codeStoryContentProvider.dispose(),this._setTraceBeingNavigatedContext(!1)}),this._sessionContext=new c(e,t,i),this._onTraceNavigationStarted=new s.EventEmitter,this.onTraceNavigationStarted=this._onTraceNavigationStarted.event}requestTrace(e={}){return this._sessionContext.requestTrace(e)}traceNavigated(e){const t={};return e&&(this._currentStep=e,this._sessionContext._traceContext.frame=e.frame),!this.traceBeingNavigated()&&this._autoPlayCodeOnStart&&(this.autoPlayCode(),delete this._autoPlayCodeOnStart),this._setTraceBeingNavigatedContext(!0),this._sessionContext.traceNavigationStarted(),!e&&this.lastActiveStep()&&(t.decorationType=this._activeTraceFrameWithNowhereToGoDecorationType,t.step=this.lastActiveStep(),this.traceBeingAutoPlayed()&&s.commands.executeCommand("quokka.pauseCodeExecution")),e&&(t.decorationType=this._activeTraceFrameDecorationType,t.step=e),t}activeTraceFrameDecorationType(){return this._activeTraceFrameDecorationType}activeTraceCallStackFrameDecorationType(){return this._activeTraceCallStackFrameDecorationType}lastActiveStep(){return this._currentStep}dispose(){this._disposed||(this.closeCodeStory(!0),this._disposables.dispose(),this._disposed=!0,delete this._currentStep,clearTimeout(this._autoPlayTimeout),delete this._autoPlayTimeout)}destroyStackTraceDecorations(e){if(e)try{e.setDecorations(this._activeTraceFrameDecorationType,[]),e.setDecorations(this._activeTraceCallStackFrameDecorationType,[]),e.setDecorations(this._activeTraceFrameWithNowhereToGoDecorationType,[])}catch(e){}}anyVisibleCodeStoryEditors(){return!!o.visibleTextEditors.find(e=>this.isCodeStoryViewer(e))}isCodeStoryViewer(e){return e&&e.document&&e.document.uri&&"quokka-code-timeline"===e.document.uri.scheme}isActiveCodeStoryViewer(e){return this.isCodeStoryViewer(e)&&this._codeStoryContentProvider.isActive()}getCodeStoryLineByStep(e){return this._codeStoryContentProvider.getLineByStep(e)}getOriginalLocationByCodeStoryLine(e){return this._codeStoryContentProvider.getOriginalLocationByLine(e)}forEachVisibleCodeStoryEditor(e){return o.visibleTextEditors.filter(e=>this.isCodeStoryViewer(e)).forEach(e)}_visibleCodeStoryEditors(){return o.visibleTextEditors.filter(e=>this.isCodeStoryViewer(e))}async viewCodeStory(e={reveal:!0}){if(!this._codeStoryContentProvider.isExpectingTimelineLoad())return this._codeStoryContentProvider.expectingTimelineLoad(),new Promise(t=>this._sessionContext.requestTestTimeline(e,async e=>{await this._codeStoryContentProvider.show(e,this._visibleCodeStoryEditors()),t()}))}async closeCodeStory(e){const t=this._codeStoryContentProvider.uri();if(this._codeStoryContentProvider.clear(this._visibleCodeStoryEditors()),t&&!this._codeStoryContentProvider.isClosing())try{this._codeStoryContentProvider.closing(),e&&(await o.showTextDocument(t,{preserveFocus:!1}),await new Promise(e=>setTimeout(()=>e(),100)),this.isCodeStoryViewer(o.activeTextEditor)&&await s.commands.executeCommand("workbench.action.closeActiveEditor"))}catch(e){}finally{this._codeStoryContentProvider.closed()}}updateTimelineEditorInlineValueDecorations(e,t,i){return this._codeStoryContentProvider.updateTimelineEditorInlineValueDecorations(e,t,i)}isClosingCodeStory(){return this._codeStoryContentProvider.isClosing()}updateCodeStoryIfLoaded(e){if(this._codeStoryContentProvider.isTimelineLoaded())return this._codeStoryContentProvider.update(e),!0}traceBeingNavigated(){return this._traceBeingNavigated}traceBeingAutoPlayed(){return!!this._autoPlayTimeout}stopTraceNavigation(){a.each(o.visibleTextEditors,e=>this.destroyStackTraceDecorations(e)),this._setTraceBeingNavigatedContext(!1),this.pauseCodeExecution(),this._sessionContext.stopTraceNavigation()}requestCallStack(){this._sessionContext.requestCallStack()}updateTraceContextCallStackFrame(e){this._sessionContext.updateTraceContextCurrentFrame(e.frame)}hideCallStack(){this._sessionContext.updateTraceContextCurrentFrame(this._currentStep&&this._currentStep.frame,!1)}autoPlayCodeOnStart(){this._autoPlayCodeOnStart=!0}autoPlayCode(){s.commands.executeCommand("setContext","quokka.traceBeingAutoPlayed",!0),this._autoPlayCode()}_autoPlayCode(e=!0){const t=s.workspace.getConfiguration().get("quokka.codeAutoPlayDelay",1e3),i=Math.max(t-50,50);this._autoPlayTimeout=setTimeout(()=>{e?a.each(o.visibleTextEditors,e=>this.destroyStackTraceDecorations(e)):s.commands.executeCommand("quokka.playTraceNextStep"),this._autoPlayCode(!e)},e?i:50)}pauseCodeExecution(){s.commands.executeCommand("setContext","quokka.traceBeingAutoPlayed",!1),clearTimeout(this._autoPlayTimeout),delete this._autoPlayTimeout}_setTraceBeingNavigatedContext(e){s.commands.executeCommand("setContext","quokka.traceBeingNavigated",e);const t=!!this._traceBeingNavigated;this._traceBeingNavigated=e,e&&!t&&this._onTraceNavigationStarted.fire()}}},{"./compositeDisposable":6,vscode:void 0}],13:[function(e,t,i){"use strict";const s=e("vscode"),a=global._;class o{constructor(e){this._context=e,this._docsNode=this._createDocsNode(),this._treeDataProvider=new l(this._docsNode),this._treeDataProvider._rootNodes={},this._treeView=s.window.createTreeView("quokkaValueExplorer",{treeDataProvider:this._treeDataProvider}),this._treeView.onDidExpandElement(e=>e.element.uiCollapsibleState=2),this._treeView.onDidCollapseElement(e=>e.element.uiCollapsibleState=1)}_createDocsNode(e){return{label:"No logged values, click to see the feature docs",iconPath:this._context.asAbsolutePath("images/question.svg"),command:{command:"vscode.open",arguments:[s.Uri.parse("https://quokkajs.com/docs/#value-explorer")]},getParent:()=>e,getLine:()=>void 0}}remove(e){const t=this._treeDataProvider._rootNodes,i=t[e.id];delete t[e.id],i&&i._context.cancelPendingUpdates(),this._treeDataProvider.refresh()}update(e,t){let i=this._treeDataProvider._rootNodes[e.id];if(!i){const t=new n(this._context,e);i=new r(t,{label:{name:`${e.id}`},id:e.id,sessionNode:!0,disallowToCopyPath:!0,disallowToCopyData:!0}),this._treeDataProvider._rootNodes[e.id]=i}i._children=a.chain(t).map(e=>{let t=(e.valueBag||{}).data;if(!t)return;t.name||o.removeExcessiveSpacesTabsLineBreaks(e.text||"").startsWith(o.removeExcessiveSpacesTabsLineBreaks(e.context||"").replace(/\.\.\.$/g,""))||(t.name=o.removeExcessiveSpacesTabsLineBreaks(e.context||""));const i=(e.loc||"").split(":")[0];return i&&(t.name=`line ${i}${t.name?`: ${t.name}`:""}`,t.line=parseInt(i,10)),t.label=t.label||{},t.label.name=t.name,t.context=e.context,t.rootValueNode=!0,t}).filter(e=>!!e).map(e=>new r(i._context,e,i,e.autoExpand)).value(),i._context.runPendingUpdates(),i._children&&i._children.length||(i._children=[this._createDocsNode(i)]),this._treeDataProvider.refresh()}reveal(e,t){const i=this._treeDataProvider._rootNodes[e];if(!i)return this._reveal(this._docsNode,{expand:!1,focus:!1,select:!1});const s={expand:!0,focus:!0},a=i.getChildren();if(a)if("function"==typeof a[Symbol.iterator]){for(const e of a)if(e.getLine()===t)return void this._reveal(e,s);this._reveal(i,s)}else a.then(()=>{const i=this._treeDataProvider._rootNodes[e];if(i){const e=i.getChildren();if(e)for(const i of e)if(i.getLine()===t)return void this._reveal(i,s);this._reveal(i,s)}});else this._reveal(i,s)}_reveal(e,t){return this._treeView.reveal(e,t).catch(()=>this._treeView.reveal(e,t).catch(e=>console.error(e)))}static removeExcessiveSpacesTabsLineBreaks(e){return e&&e.replace(/\r\n\s*/g," ").replace(/\n\s*/g," ")}}class n{constructor(e,t){this._expressionsToEvaluate={},this._onUpdate=[],this._extensionContext=e,this._session=t,this.id=t.id}asAbsolutePath(e){return this._extensionContext.asAbsolutePath(e)}isPathRequested(e,t){let i=this._expressionsToEvaluate;const s=a.every(e,e=>!!i[e]&&(i=i[e],!0));return s&&t?JSON.stringify(t)===JSON.stringify(i):s}requestNodes(e,t){let i=this._expressionsToEvaluate;a.each(e,e=>{i[e]=i[e]||{},i=i[e]}),t&&(i.props=t.props,i.strLength=t.strLength,i.ranges=t.ranges),this._session.isDisposed()||(this._session.expressionsToEvaluate(this._expressionsToEvaluate),this._session.runTests({file:this._session.fileName}))}scheduleOnUpdate(e){this._onUpdate.push(e)}copyToClipboard(e){!this._session.isDisposed()&&this._session.copyToClipboard(e)}cancelPendingUpdates(){this._onUpdate=[]}runPendingUpdates(){a.each(this._onUpdate,e=>e()),this._onUpdate.length=0}}class r{constructor(e,t,i,a){this._context=e,this._parent=i,this._data=t,this.label=this._createLabel(),this._queryPath=t.queryPath,this.id=(a?"A":"")+this._context.id+"."+t.id,this.iconPath=this._getIconPath(),t.disallowToCopyPath||(this.contextValue+="QuokkaAllowToCopyPath"),t.disallowToCopyData||(this.contextValue+="QuokkaAllowToCopyData"),this._autoExpand=a&&!this._data.cappedProps&&!this._data.capped&&!this._data.loadActionNode&&!this._data.rangeNode&&"string"!==this._data.type&&!this._data.getter&&!this._data.setter,t.sessionNode?this.collapsibleState=2:this.collapsibleState=t.expandable?this._autoExpand?2:1:0,t.rangeNode&&(this._parentArray=i._parentArray||i,this._queryPath=this._parentArray._queryPath),t.sessionNode&&(this.iconPath=s.ThemeIcon.File,this.resourceUri=s.Uri.file(this.id))}getChildren(){if(this._children)return this._children;if("string"===this._data.type)return this._getChildren({strLength:Number.MAX_VALUE});if(this._data.loadActionNode)return this._getChildren({props:Number.MAX_VALUE});const e=(this._data.props||[]).map(e=>new r(this._context,e,this,this._autoExpand)),t=e=>e._data.functionsNode||e._data.loadActionNode||e._data.callStackNode;return this._data.rangeNode||"array"===this._data.type||"Map"===this._data.type||"Set"===this._data.type||e.sort(function(e,i){if(t(e)||t(i))return 0;const s=((e._data.label||{}).name||"").toLowerCase(),a=((i._data.label||{}).name||"").toLowerCase();return s<a?-1:s>a?1:0}),e.length?Promise.resolve(e):this._data.rangeNode?this._getChildren({ranges:{props:JSON.parse(JSON.stringify(this._parentArray._data.props,(e,t)=>(t.props&&(!t.props.length&&t===this._data||t.props.length&&!t.props[0].rangeNode)&&(t.props=!0),t))),length:this._parentArray._data.length}}):this._getChildren()}getParent(){return this._parent}getLine(){return this._data.line}copyExpressionPath(){(this._data||{}).expressionPath&&this._context.copyToClipboard(this._data.expressionPath.join(""))}copyExpressionData(){this._data&&this._context.copyToClipboard(this._data)}_getChildren(e){return this._context.isPathRequested(this._queryPath,e)?[]:(this._context.requestNodes(this._queryPath,e),new Promise((e,t)=>{this._context.scheduleOnUpdate(e)}))}_getIconPath(){if(this._data.getter)return this._context.asAbsolutePath("images/getter.svg");if(this._data.functionsNode)return this._context.asAbsolutePath("images/function.svg");if(this._data.loadActionNode)return this._context.asAbsolutePath("images/more.svg");if(this._data.error)return this._context.asAbsolutePath("images/error.svg");if(this._data.rangeNode)return this._context.asAbsolutePath("images/range.svg");if(!this._data.sessionNode){if(this._data.type)switch(this._data.type.toLowerCase()){case"string":if(this._data.capped)return this._context.asAbsolutePath("images/cappedString.svg");case"object":case"array":case"number":case"function":case"boolean":case"date":case"regexp":case"symbol":case"null":case"undefined":return this._context.asAbsolutePath(`images/${this._data.type.toLowerCase()}.svg`)}return this._context.asAbsolutePath("images/object.svg")}}_createLabel(){const e=this._data.label;let t="";return e.name&&(t+=e.name),e.type&&(t+=`: ${e.type} `),e.value&&(t+=(e.type?"":": ")+e.value),t}}class l{constructor(e){this._onDidChangeTreeData=new s.EventEmitter,this.onDidChangeTreeData=this._onDidChangeTreeData.event,this._docsNode=e}refresh(){this._onDidChangeTreeData.fire()}getTreeItem(e){return e}getParent(e){if(e)return e.getParent()}getChildren(e){return e?e.getChildren():a.isEmpty(this._rootNodes)?Promise.resolve([this._docsNode]):Promise.resolve(a.chain(this._rootNodes).values().sortBy(e=>e._data.name).value())}}t.exports=o},{vscode:void 0}]},{},[2]);